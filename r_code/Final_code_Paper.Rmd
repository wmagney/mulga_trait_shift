# STATs for Mulga trait shift paper 



# set up

```{r}

library(lme4) #mixed effect linear models

library(MuMIn)

library(lmerTest)

library(emmeans)

library(tidyverse)

library(readr)

library(nlme)

library(ggpmisc)

library(cowplot)

library(car)

library(forcats)

library(msm)

library(mgcv)

library (glmmTMB)

library(ape)

library(ggpmisc)

library(multcomp)

library(DHARMa)

library(MASS)

library(betareg)

library(smatr)
```


# TRAIT LEVEL METRICS


```{r}
#Plant vessel's Data

#build data set 

vessels <- read_csv("input_data/trait_data/vessel.csv")%>%
  mutate(rainfalllow = ifelse (grepl ("STURT", name), "low", "moderate"),
          rainfallhigh = ifelse (grepl ("GUNDA", name), "high", "moderate"),
          landform = ifelse (grepl ("SHED", name), "shed", "acc"),
          rainfall = ifelse(rainfalllow == "low", "low",
                          ifelse(rainfallhigh == "high", "high", "moderate")),
          rainfall = as.factor(rainfall),
         landform = as.factor(landform),
         length = as.numeric(length),
         width = as.numeric(width),
         rainfall = factor(rainfall, levels = c("low", "moderate", "high")))%>%
  
  #extract tree as a grouping factor from the name variable
  
  mutate(
    tree = substr(name, start = 1, stop = 13))%>%
  
  #get log transformations of various variables
  mutate(log.roundness = log(roundess),
         log.area = log(area))
 
  
  f.vessels <- vessels%>% 
    filter(, l_ratio > 0.20)%>%
    filter(, roundess > 0.15)%>%
    filter(, area < 3000)%>%
    filter(, area > 60)%>%
    filter(, width > 3)%>%
     
  #turn point values into area (pixel spacial resolution 1.17um across images on average with small variance (total range = 0.014um))
  mutate(area = 1.17*area,
         length = 1.17*length,
         width = 1.17*width,
         perimeter = 1.17*perimeter)


  summary(vessels)


```




```{r}

#leaf data 

total_leaves <- read_csv("input_data/trait_data/leaves/total_leaves.csv")%>%
  mutate( rainfall = factor(rainfall, levels = c("low", "moderate", "high")))


summary(total_leaves)

```




```{r}
trait_SLA <- total_leaves%>%
  mutate(
    tree_number = as.factor(tree_number),
    sla = leaf_mass/leaf_area, #cm^2/mg
    volume = leaf_area * leaf_thickness
    )%>%
  arrange(tree_number)%>%
  filter(!is.na(sla))%>%
  aggregate(sla~tree_number + landform + volume + leaf_area + leaf_thickness  + leaf_mass + wood_density + rainfall,mean)

summary(trait_SLA)
```

```{r}
leaf_thickness.df <- total_leaves%>%
  mutate(
    m.leaf_thickness = mean(leaf_thickness)
    )%>%
  arrange(tree_number)%>%
  filter(!is.na(leaf_thickness))%>%
  aggregate(leaf_thickness ~ tree_number + landform + leaf_area + leaf_thickness  + leaf_mass + wood_density + rainfall,mean)

summary(leaf_thickness.df)
```


```{r}
# Wood density data

total_wood <- read_csv("input_data/trait_data/wood/total_wood.csv")%>%
  mutate( rainfall = factor(rainfall, levels = c("low", "moderate", "high")))


summary(total_wood)

```


```{r}

wood_data <- total_wood%>%
  mutate(
    basal_area = (wood_thickness*0.5)^2*3.14159265359,
    volume = basal_area * wood_length,
    wood.dens = wood_mass/volume)

summary(wood_data)

```



## Vessel roundness model (GLMM)


```{r}

lmem.roundness <- lmer(log.roundness ~ rainfall  + (1|tree), data = f.vessels)

summary(lmem.roundness)
```

```{r}
## coefficent of variance


confint(lmem.roundness)
```


```{r}

## low rainfall estimates and CI roundness 
exp(-1.0185754)

exp(-0.8230986)

exp(-0.92086)
```

```{r}

# high rinfall estimates and CI roundenss
exp(-1.0185754 -0.1319110)

exp(-0.8230986  + 0.2168832)

exp(-0.92086 + 0.04248)
```




### Assumptions

```{r}

lmem.roundness <- lmer(log.roundness ~ rainfall + landform + (1|tree), data = f.vessels)

summary(lmem.roundness)

```



```{r}

scatter.smooth(residuals(lmem.roundness) ~ fitted(lmem.roundness))
```

```{r}
qqnorm(residuals(lmem.roundness), pch = 1, frame = FALSE)
qqline(residuals(lmem.roundness), col = "steelblue", lwd = 2)
```

***distributional assumptions not met find a new model***

```{r}
# Extract the residuals from the model
residuals <- residuals(lmem.roundness)

# Perform the ACF analysis
 acf(residuals)
```
### compare GLM with various distributional assumptions
```{r}
vessels%>%
  ggplot( aes(x = roundess))+
  geom_histogram()+
  ggtitle("vessel roundess distribution")
  
```
***fits beata distribution the best***



```{r}

gamma.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = Gamma())

beta.glmm.roundness <- glmmTMB(roundess ~ rainfall  + (1|landform/tree), data = f.vessels,family = beta_family())

anova(gamma.glmm.roundness, beta.glmm.roundness, test = "LRT")

```


```{r}
possion.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = poisson())

anova(beta.glmm.roundness, possion.glmm.roundness, test = "LRT")
```



```{r}

lmem.roundness <- lmer(log.roundness ~ rainfall + (1|landform/tree), data = f.vessels)

beta.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels, family = beta_family())

# Compare the models using likelihood ratio test (LRT)
anova(lmem.roundness, beta.glmm.roundness, test = "LRT")

```


```{r}

scatter.smooth(residuals(beta.glmm.roundness) ~ fitted(beta.glmm.roundness))
```



```{r}
beta.roundness.SimRes <- simulateResiduals(fittedModel  = beta.glmm.roundness)

plot(beta.roundness.SimRes)

```




```{r}
summary(beta.glmm.roundness)
```



***glmm with beta distribution best***



***rainfall not significant***




### fixed effect hypothesis testing 

```{r}
beta.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = beta_family())

beta.glmm.roundness.null <- glmmTMB(roundess ~ (1|landform/tree), data = f.vessels,family = beta_family())

anova(beta.glmm.roundness, beta.glmm.roundness.null, test = "chisq")
```

***rainfall not significant***
```{r}
vessel.roundness <- ggplot( f.vessels, aes(rainfall, roundess, fill = rainfall))+
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("a")+
  ylab ("xylem roundness")+
  xlab("rainfall site")+
  theme(legend.position = "none")

print(vessel.roundness)

ggsave("outputs/trait/vessel.roundness.png")

```




```{r}
mean(f.vessels$roundess)
```



## Vessel area model (LMEM)

```{r}

area.model <- lmer(log.area ~ rainfall +  (1|tree), REML = T, data = f.vessels)

summary(area.model)

```






### assumptions





```{r}


qqnorm(residuals(area.model), pch = 1, frame = FALSE)
qqline(residuals(area.model), col = "steelblue", lwd = 2)
#plot(area.model, which = 2)


```

```{r}

scatter.smooth(residuals(area.model) ~ fitted(area.model))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(area.model)

# Perform the ACF analysis
 acf(residuals)
```

### fixed effect hypothesis testing 


```{r}
area.model <- lmer(log.area ~ rainfall +  (1|tree), REML = T, data = f.vessels)
area.model.null <- lmer(log.area ~  (1|tree), REML = T, data = f.vessels)


anova(area.model, area.model.null, test = "LRT")
```

***rainfall not significant***




```{r}
 area.model<- lmer(log.area ~ rainfall +  (1|tree), REML = T, data = f.vessels)

summary(area.model)

```


```{r}
#confidence intervals 


confint(area.model)
```


```{r}
#low rainfall vessel area
 
exp(5.86992556) # lower

exp(6.012841221) # upper 

exp(5.94151)    #mean
```



```{r}
#moderate rainfall vessel area


exp(5.86992556 - 0.20654292) #lower 

exp(6.012841221 -  0.003794794) # upper 

exp(5.94151 - 0.10507 )  #mean 


```





```{r}
#diamiter
ggplot(f.vessels, aes(log.area, colour = rainfall)) +
  geom_histogram()

xylem_area <- ggplot( f.vessels, aes(rainfall, area, fill = rainfall))+
  geom_boxplot()+
  theme_cowplot()+
  scale_y_log10()+
  ggtitle("B")+
  ylab(bquote("xylem area " (Î¼m^2)))+
  xlab("")+
  theme(legend.position = "none")

print(xylem_area)

```



```{r}
mean(f.vessels$area)
```


## Wood denisty model 

```{r}

wood.dens.aov <- aov(log(wood.dens) ~ rainfall, data = wood_data)

summary(wood.dens.aov)

```



```{r}

qqnorm(residuals(wood.dens.aov), pch = 1, frame = FALSE)
qqline(residuals(wood.dens.aov), col = "steelblue", lwd = 2)

```



```{r}
plot(wood.dens.aov, which = 1)
```


```{r}
# Extract the residuals from the model
residuals <- residuals(wood.dens.aov)

# Perform the ACF analysis
 acf(residuals)
```


### fixed effect hypothesis testing 

```{r}

log.wood.dens.aov <- aov(log(wood.dens) ~ rainfall, data = wood_data, )


summary(log.wood.dens.aov)

```

```{r}

### estimates and CIs for wood density 

coef(log.wood.dens.aov)

confint(log.wood.dens.aov)
```


```{r}
## CIs for wood density low

exp(-0.12803192) #mean 

exp(-0.17401344) #lower

exp(-0.08205040) #upper

```


```{r}
## CIs for wood density moderate 

exp(-0.12803192 - 0.03583338) #mean 

exp(-0.17401344 - 0.10209981) #lower

exp(-0.08205040 + 0.03043304) #upper

```





***rainfall not significant***

```{r}

wood.density <- wood_data%>%
  ggplot(aes(rainfall, wood.dens, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab(bquote("wood density " (g ~ cm^-3)))+
  theme_cowplot()+
  xlab(" ")+
  ggtitle("C")+
  theme(legend.position = "none")


print(wood.density)

```

```{r}
mean(wood_data$wood.dens)
```



```{r}
# Extract the residuals from the model
residuals <- residuals(wood.dens.aov)

# Perform the ACF analysis
 acf(residuals)
```







## SLA model 

`

```{r}
SLA.anova <- aov(log(sla) ~  rainfall/landform, data = trait_SLA)

```



```{r}

qqnorm(residuals(SLA.anova), pch = 1, frame = FALSE)
qqline(residuals(SLA.anova), col = "steelblue", lwd = 2)

```


```{r}
plot(SLA.anova, which = 1)
     
```


```{r}
# Extract the residuals from the model
residuals <- residuals(SLA.anova)

# Perform the ACF analysis
 acf(residuals)
```





### Final SLA model fit

```{r}
SLA.anova <- aov(log(sla) ~  rainfall/landform, data = trait_SLA)


TukeyHSD(SLA.anova)


summary(SLA.anova)
```





```{r}
# estimates of CI for SLA 

coef(SLA.anova)

confint(SLA.anova)
```

```{r}
## CIs for MLA low rainfall 


exp(-4.0286620) #mean 

exp(-4.1330780) #lower

exp(-3.9242460) #upper


```


```{r}
## CIs for MLA moderate rainfall 


exp(-4.0286620 + 0.3664057) #mean 

exp(-4.1330780 +  0.2245323) #lower

exp(-3.9242460 +  0.5082791) #upper


```


```{r}
## CIs for MLA high rainfall 


exp(-4.0286620 +  0.6658169) #mean 

exp(-4.1330780 +  0.5212595  ) #lower

exp(-3.9242460 +  0.8103743) #upper


```



```{r}

d.massvsarea <- trait_SLA%>%
  ggplot(aes(rainfall, sla, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab(bquote("LMA" ~ (mg ~ cm^-2)))+
  xlab("   ")+
  ggtitle("D")+ 
  theme_cowplot()+
  theme(legend.position = "none")

print(d.massvsarea)

#ggsave("outputs/traits/d.massvsarea.png")

```

```{r}
plot(SLA.anova, which = 1)
```









## Leaf area 

```{r}

leaf_area.aov <- aov(log(leaf_area) ~  rainfall/landform, data = trait_SLA)

summary(leaf_area.aov)

TukeyHSD(leaf_area.aov)

```
```{r}
leaf_area.aov <- lm(log(leaf_area) ~  rainfall, data = trait_SLA)

summary(leaf_area.aov)
```




```{r}
qqnorm(residuals(leaf_area.aov), pch = 1, frame = FALSE)
qqline(residuals(leaf_area.aov), col = "steelblue", lwd = 2)

```


```{r}
plot(leaf_area.aov, which = 1)
     
```


}
```{r}

# Extract the residuals from the model
residuals <- residuals(leaf_area.aov)

# Perform the ACF analysis
 acf(residuals)
```


```{r}

leaf.area <- trait_SLA%>%
  ggplot(aes(rainfall, leaf_area, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab(bquote("leaf area " (cm^2)))+
  xlab("   ")+
  ggtitle("D")+ 
  theme_cowplot()+
  theme(legend.position = "none")

print(leaf.area)

#ggsave("outputs/trait/leaf.area.png")

```

## leaf thickness 



```{r}
leaf.thickness.lm <- lm(log(leaf_thickness) ~ rainfall, data = leaf_thickness.df)

summary(leaf.thickness.lm)
```




```{r}
qqnorm(residuals(leaf.thickness.lm), pch = 1, frame = FALSE)
qqline(residuals(leaf.thickness.lm), col = "steelblue", lwd = 2)

```


```{r}
plot(leaf.thickness.lm, which = 1)
     
```


```{r}

# Extract the residuals from the model
residuals <- residuals(leaf.thickness.lm)

# Perform the ACF analysis
 acf(residuals)
 
```

```{r}

leaf.thick <- leaf_thickness.df%>%
  ggplot(aes(rainfall, leaf_thickness, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab("leaf thickness mm")+
  xlab("   ")+
  ggtitle("D")+ 
  theme_cowplot()+
  theme(legend.position = "none")

print(leaf.thick)

#ggsave("output/triat/leaf.thick.png")
```




# INDIVIUDAL TREE LEVEL METRICS

## build data sets

### import/build data set



```{r}
total_plots <- read_csv("input_data/plot_data/total_plots.csv")%>%
  mutate(
   landform = as.factor(landform),

    plots = as.factor(plots),
   
   subplot = as.factor(subplot),

    rainfall = factor(rainfall, levels = c("low", "moderate" , "high")))

summary(total_plots)
```



```{r}
total_wood <- read_csv("~/Thesis/r_studio/trait_data/wood/total_wood.csv")%>%
  mutate( rainfall = factor(rainfall, levels = c("low", "moderate", "high")))


summary(total_wood)

```


### calcuale basal area and summed biomass



```{r}

 #calculate basal area   
  basal_area <- total_plots %>%
  gather("d_10", "diamiter", starts_with ("d_"))%>%
  mutate(basal_area = (diamiter*0.5)^2*3.14159265359)%>%
  arrange(tree)%>%
  filter(!is.na(diamiter))
```


```{r}
#log allometric variables 
logbasal <- basal_area%>%
  mutate(log.height = log(height), 
         log.basal = log(basal_area))
```



### daimeter estimates for individual trees

```{r}
mean(logbasal$log.height)

mean(logbasal$log.basal)

mean(logbasal$basal_area)
```





```{r}
exp(3.38895)
exp(5.971321)
```



```{r}
  
#back transform basal to single stem estimate. 
#mean centre log transformed tree metrics 

    D2H_model <- logbasal %>%
   group_by(tree, log.height, height, log.basal, landform, plots, rainfall, subplot, sub_plot_area, subplot_density, plot_density)%>%
  summarise(basal_area = sum(basal_area),.groups = "drop")%>%
      mutate(diamiter = (sqrt(basal_area/3.14159265359))*2,
             log.mc.height = log.height-5.971321,
             log.mc.basal = log.basal-3.38895)

```



```{r}
mean(D2H_model$log.mc.height)

mean(D2H_model$log.mc.basal)
```


### filtered 

```{r}
#filter out smaller trees due to allometeric differences in juveniles

f.D2H_model <- filter(D2H_model, diamiter > 2) 

f.h.D2H_model <- filter(f.D2H_model, height > 40)


```



### pairwise rainfall datasets 


```{r}
high_mod.D2H_model <- f.D2H_model %>% filter(rainfall != 'low')

high_low.D2H_model <- f.D2H_model %>% filter(rainfall != 'moderate')

mod_low.D2H_model <- f.D2H_model %>% filter(rainfall != 'high' )
```




### allometric data with canopy volume

```{r}

allometry_total <- read_csv("input_data/allometry/allometry_total.csv")%>%
 mutate(
   landform = as.factor(landform),

    rainfall = factor(rainfall, levels = c( "low", "moderate", "high")))

summary(allometry_total)

```



### calculate basal area and canopy volume



```{r}

#calcualte basal area
allo_basal <- allometry_total %>%
  gather("d10", "diamiter", starts_with ("d10"))%>%
  mutate(basal_area = (diamiter*0.5)^2*3.14159265359)%>%
  arrange(tree)%>%
  filter(!is.na(diamiter))

```




```{r}

canopy_volume <- allo_basal%>%
  group_by(tree, canopy_1, canopy_2, `95_Canopy`, tree_height, landform, rainfall)%>%
  summarise(basal_area = sum(basal_area),.groups = "drop")%>%
  mutate(canopy_height = ((tree_height - `95_Canopy`)/2),  # divide by 2 to get the semi-axis
         canopy_length = canopy_1/2,
         canopy_bredth = canopy_2/2,
         canopy_vol= (3/4 * 3.141593 * canopy_height *canopy_bredth * canopy_length)/1000000,# volume of an ellipsoid. Divide by 1,000,000 to get m3
         log.tree.H = log(tree_height),
         log.canopy.V = log(canopy_vol),
         log.basal_area = log(basal_area),
         cent.log.h = log.tree.H - 1.641818,
         cent.log.b = log.basal_area -4.924167,
         #grand mean center allometric variables 
         mc.tree_height = log.tree.H -  5.971321,   #centred on f.d2h basal area mean
         mc.basal_area = log.basal_area -  3.38895, #centred on f.d2h basal area mean
         mc.cv = log.canopy.V - 2.174772)%>%
  filter(!is.na(canopy_vol))%>%
  filter(!is.na(log.canopy.V))

```


```{r}
mean(canopy_volume$log.tree.H)

mean(canopy_volume$log.basal_area)

mean(canopy_volume$log.canopy.V)

```
```{r}

```


```{r}
mean(canopy_volume$mc.tree_height)

mean(canopy_volume$mc.basal_area)

mean(canopy_volume$mc.cv)
```


```{r}

summary(canopy_volume)

```

***canopy volume is within standard estimates of mature trees from other studies "Canopy Area and Aboveground Mass of Individual Redberry Juniper"*****

### pairwise data frames 

```{r}
low_high_cv <- canopy_volume %>%
  filter(rainfall != "moderate")

low_mod_cv<- canopy_volume %>%
  filter(rainfall != "high")

mod_high_cv <- canopy_volume %>%
  filter(rainfall != "low")
```






b.a_graph <- f.D2H_model %>%
  ggplot(aes(rainfall, basal_area, fill = rainfall))+
  geom_boxplot( notch = F)+
  scale_y_log10()+
  ggtitle("D")+
  ylab(bquote("basal area "(cm^2)))+
  xlab("rainfall")+
  theme_cowplot()+
  theme(legend.position = "none")

print(b.a_graph)



## check distributions 

```{r}
f.D2H_model %>% ggplot( aes(log.mc.basal, fill = rainfall ))+
  geom_histogram()

f.D2H_model %>% ggplot( aes(log(basal_area), fill = rainfall ))+
  geom_histogram()
```

```{r}
f.D2H_model %>% ggplot( aes(log.mc.height, fill = rainfall ))+
  geom_histogram()

f.D2H_model %>% ggplot( aes(log(height), fill = rainfall ))+
  geom_histogram()
```


```{r}
canopy_volume %>% ggplot( aes(mc.tree_height, fill = rainfall ))+
  geom_histogram()

canopy_volume %>% ggplot( aes(log(tree_height), fill = rainfall ))+
  geom_histogram()
```


## Basal area (LMEM)


```{r}

final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot), data = f.D2H_model, REML = T)

summary(final.basal.fit)



```
### assumptions

```{r}
qqnorm(residuals(final.basal.fit), pch = 1, frame = FALSE)
qqline(residuals(final.basal.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.basal.fit) ~ fitted(final.basal.fit))
```


```{r}
# Extract the residuals from the model
basal.residuals <- residuals(final.basal.fit)

# Perform the ACF analysis
 acf(basal.residuals)
```
### fixed effect hypothesis testing 


final.height.basal.aov <- lmer(log(height) ~ log(basal_area) * rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F)
final.height.null <- lmer(log(height) ~ log(basal_area) + (1|landform/plots/subplot), data = f.D2H_model, REML = F)

anova(final.height.null,final.height.basal.aov,test = "LRT")


```{r}
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|landform/plots/subplot), data = f.D2H_model, REML = F)

final.basal.null <- lmer(log(basal_area) ~  (1| landform/plots/subplot), data = f.D2H_model, REML = F)

anova(final.basal.null, final.basal.fit, test = "LRT")
```


### random effect hypothesis testing 

```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.basal.null <- lmer(log(basal_area) ~  rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) #null model
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.basal.fit) - 2 * logLik(final.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logBasalSim <- unlist(simulate(final.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~  rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logBasalSim ~ rainfall + (1 | landform/plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```



```{r}
#test if we need plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.basal.null <- lmer(log(basal_area) ~  rainfall + (1|subplot) , data = f.D2H_model, REML = F) #null model
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.basal.fit) - 2 * logLik(final.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logBasalSim <- unlist(simulate(final.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~  rainfall + (1 |subplot), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logBasalSim ~ rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```
***plots significant***





```{r}
#test if we need landform given we have subplots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.basal.null <- lmer(log(basal_area) ~  rainfall + (1|plots) , data = f.D2H_model, REML = F) #null model
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.basal.fit) - 2 * logLik(final.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logBasalSim <- unlist(simulate(final.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~  rainfall + (1 | plots), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logBasalSim ~ rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```
```{r}

```


***subplot significant***


```{r}
basal_area_graph <- f.D2H_model%>%
  ggplot( aes( basal_area, height, fill = rainfall))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab("height (cm)")+
  xlab(" ")+
  ggtitle("E")+
  theme_cowplot()+
   theme(legend.position = "none")
  

print(heightvsrainfall)
```


## Basal area to height (SMA)



```{r}
#slope test 

sma.ba_h.test <- sma(log.height ~ log.basal* rainfall, data = f.D2H_model )




summary(sma.ba_h.test)
```
***sig diff*** 

### differences between sites slopes 

***bonferoni correction alpha set at 0.0166667

```{r}
sma.ba_h.high_low <- sma(log.height ~ log.basal* rainfall, data = high_low.D2H_model )

summary(sma.ba_h.high_low)
```
***difference in slope high_low***

```{r}
sma.ba_h.high_mod <- sma(log.height ~ log.basal* rainfall, data = high_mod.D2H_model )

summary(sma.ba_h.high_low)
```
***high mod sig diff in slopes***


```{r}
sma.ba_h.mod_low <- sma(log.height ~ log.basal* rainfall, data = mod_low.D2H_model )

summary(sma.ba_h.mod_low)
```

***mod low differences in slope***





### elevation test

```{r}
# Difference in mean centred elevation 

sma.int.BA_H<- with(f.D2H_model, method = 'SMA', elev.com(log.height, log.mc.basal, rainfall))

sma.int.BA_H

```


### differences in elevation

```{r}
sma.int.ba_h.high_low<- with(high_low.D2H_model, method = 'SMA', elev.com(log.height, log.mc.basal, rainfall))


sma.int.ba_h.high_low
```

**significant**


```{r}
sma.int.ba_h.high_mod<- with(high_mod.D2H_model, method = 'SMA', elev.com(log.height, log.mc.basal, rainfall))


sma.int.ba_h.high_mod
```

**significant**

```{r}
sma.int.ba_h.mod_low<- with(mod_low.D2H_model, method = 'SMA', elev.com(log.height, log.mc.basal, rainfall))


sma.int.ba_h.mod_low
```
**significant**



### mean centered intercept estimates and CIs 

```{r}
exp(5.858584) #low elevation 

exp(5.841859)

exp(5.875309)

```



```{r}
exp(5.969946) #mod elevation 

exp(5.947505)

exp(5.992386)

```

```{r}
exp(6.224564)
exp(6.204829)
exp(6.244299)
```




### visualise functions



```{r}
# NOT mean centered

sma.ba_h.test <- sma(log.height ~ log.basal * rainfall, data = f.D2H_model)



summary(sma.ba_h.test)
```




```{r}
# non mean centered intercepts  

exp(4.861392 )
exp(5.334735 )
exp(5.025324 )
```





```{r}
#functions for BA Vs H (use intercepts form non mean centered fit )


sma.H.BA.FUN.L <- function(x) {129.2039 * x^0.2945913 }

sma.H.BA.FUN.M <- function(x) {207.4178 * x ^0.2105044 }

sma.H.BA.FUN.H <- function(x) {152.2196 * x^0.3535720 }


```




```{r}
#mean centered plot 
sma.basal.vs.heigh_plots <- f.D2H_model%>%
  ggplot(aes(basal_area, height, colour = rainfall))+
  geom_point()+
  geom_function(fun = sma.H.BA.FUN.L, n = 105, colour = "coral2", size = 1)+
  geom_function(fun = sma.H.BA.FUN.M, n = 105, colour = "forestgreen", size = 1)+
  geom_function(fun = sma.H.BA.FUN.H, n = 105, colour =  "deepskyblue3 ", size = 1)+
  ylab("height (cm)")+
  xlab(bquote("basal area "(cm^2)))+
  geom_vline(xintercept=29, colour = "goldenrod1", size = 1)+
  xlim(0,1250)+
  ggtitle("A")+
  theme_cowplot()+
  theme(axis.title=element_text(size=12), legend.position = "none")
  

print(sma.basal.vs.heigh_plots)

ggsave("outputs/tree_sturcture/sma.basal.vs.heigh_plots.png")
```







```{r}
#functions for BA Vs H not mean centered 


```




## Tree height (GLMM)

```{r}
final.tree.height.lm <- lmer(log(height) ~  rainfall + (1|plots/subplot), data = f.D2H_model, REML = F)

summary(final.tree.height.lm)

```






```{r}

final.tree.height.lm <- lmer(log(height) ~  rainfall + (1|plots/subplot), data = f.D2H_model, REML = F)

final.tree.height.lm.null <- lmer(log(height) ~  (1|plots/subplot), data = f.D2H_model, REML = F)

anova(final.tree.height.lm.null, final.tree.height.lm, test = "LRT")
```




```{r}
pairs(emmeans(final.tree.height.lm, ~ rainfall))
```





### assumptions

```{r}

qqnorm(residuals(final.tree.height.lm), pch = 1, frame = FALSE)
qqline(residuals(final.tree.height.lm), col = "steelblue", lwd = 2)


```



```{r}
scatter.smooth(residuals(final.tree.height.lm) ~ fitted(final.tree.height.lm))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(final.tree.height.lm)

# Perform the ACF analysis
 acf(residuals)
```
***fit diagnostics indicates violation of the distributional assumptions***



### GLMM height model 


```{r}
ggplot(f.D2H_model, aes(height, colour = rainfall)) +
  geom_histogram()+
  scale_x_log10()

```


```{r}
height.GLMM.gamma <- glmmTMB(height ~ rainfall + (1|plots/subplot), data = f.D2H_model,family = Gamma(link = "log"))

height.glmm.norm <- glmmTMB(height ~ rainfall + (1|plots/subplot), data = f.D2H_model,family = gaussian(link = "identity"))

summary(height.GLMM.gamma)
#summary(height.glmm.norm)
```




```{r}
confint(height.GLMM.gamma)

```

```{r}
# estimates for low rainfall height 

exp(5.835619826)
exp(6.1587349)
exp(5.9971773)
```


```{r}
# estiamtes for moderate 


exp(5.835619826 + 0.007713873)
exp(6.1587349 + 0.4520716)
exp(5.9971773 + 0.2298927)

```


```{r}
# high rainfall 


exp(5.835619826 +  0.075209160)
exp(6.1587349 + 0.5371835)
exp(5.9971773 + 0.3061963)

```


```{r}

height.emm<- pairs(emmeans(height.GLMM.gamma, ~ rainfall))
summary(height.emm)

```

```{r}
confint(height.emm)
```

```{r}
exp(-0.3062)
exp(-0.582)
exp(-0.0300)
```



```{r}
gamma.height.SimRes <- simulateResiduals(fittedModel  = height.GLMM.gamma)

plot(gamma.height.SimRes)
```



final.tree.height.lm


```{r}
norm.height.SimRes <- simulateResiduals(fittedModel  = height.glmm.norm)

plot(norm.height.SimRes)
```



```{r}
# Extract the residuals from the model
residuals <- residuals(final.tree.height.lm)

# Perform the ACF analysis
 acf(residuals)
```


```{r}
durbinWatsonTest(residuals)

```



### fixed effect hypothesis testing 



```{r}
height.GLMM.gamma <- glmmTMB(height ~ rainfall + (1|plots/subplot), data = f.D2H_model,family = Gamma(link = "log"))

height.GLMM.gamma.null <- glmmTMB(height ~  (1|plots/subplot), data = f.D2H_model,family = Gamma(link = "log"))

anova(height.GLMM.gamma.null, height.GLMM.gamma, test = "Chisq")
```
```{r}

```




```{r}
pairs(emmeans(height.GLMM.gamma, ~ rainfall))
```



```{r}

heightvsrainfall <- f.D2H_model%>%
  ggplot( aes( rainfall, height, fill = rainfall))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab("height (cm)")+
  xlab(" ")+
  ggtitle("E")+
  theme_cowplot()+
   theme(legend.position = "none")
  

print(heightvsrainfall)

```




## Canopy volume vs basal area (SMA)

```{r}
sma.ba_CV.test <- sma(log.canopy.V ~ mc.basal_area * rainfall, data=canopy_volume)


summary(sma.ba_CV.test)
```
***no difference in slope***

```{r}
ba_cv<- sma.ba_CV.test <- sma(log.canopy.V ~ mc.basal_area, data=canopy_volume)

summary(ba_cv)
```


```{r}
exp(0.2260996700) #mean centred int 
exp(-0.0008332903)
exp(0.4530326303)

```



### elevation test 

```{r}
# Difference in mean centred elevation 

sma.int.ba_CV<- with(canopy_volume, method = 'SMA', elev.com(log.canopy.V, mc.basal_area, rainfall))

sma.int.ba_CV

```




### transformed intercepts 



```{r}
 
#low rainfall        

exp(0.01723195) #mean 

exp(-0.37787930) #lower

exp(0.4123432) #upper 

```


```{r}

#moderate rainfall

exp(0.01195972) #mean

exp(-0.32101797) #lower

exp(0.3449374) #upper

```


```{r}
#high rainfall 

exp(0.33718698)#mean

exp(0.02498298) #upper 

exp(0.6493910) #lower


```



### CV to BA functions 

```{r}
sma.ba_CV.test <- sma(log.canopy.V ~ log.basal_area * rainfall, data=canopy_volume)


summary(sma.ba_CV.test)
```



```{r}
exp(-3.743134 )
exp(-4.825868 )
exp(-4.228895 )

```



```{r}

# define Canopy area to height area function from above ANCOVA 

CV.BA.FUN.L <- function(x) {0.02367977 * x^1.177229}

CV.BA.FUN.M <- function(x) {0.00801959 * x ^1.388406}

CV.BA.FUN.H <- function(x) {0.01456848 * x^1.343042}
```


### visualise CV.BA SMA



```{r}
sma_CV_BA <- canopy_volume%>%
  ggplot(aes(basal_area, canopy_vol, colour = rainfall))+
  geom_point()+
  geom_function(fun = CV.BA.FUN.L, n = 105, colour = "coral2", size = 1)+
  geom_function(fun = CV.BA.FUN.M, n = 105, colour = "forestgreen", size = 1)+
  geom_function(fun = CV.BA.FUN.H, n = 105, colour =  "deepskyblue3 ", size = 1)+
  ylab(bquote("canopy volume " (m^3)))+
  xlab(bquote("basal area "(cm^2)))+
  geom_vline(xintercept=29, colour = "goldenrod1", size = 1)+
  ggtitle("B")+
  theme_cowplot()+
  theme(axis.title=element_text(size=12), legend.position = "none")
  

print(sma_CV_BA)

#ggsave("outputs/tree_sturcture/sma_CV_BA.png")
```



## Canopy volume vs height (SMA)

```{r}
sma.CV_h.test <- sma(mc.cv ~ mc.tree_height * rainfall, data=canopy_volume)


summary(sma.CV_h.test)
```
### differences in slope 



```{r}
sma.int.CV_H <- sma(log.canopy.V ~ mc.tree_height * rainfall, data=low_high_cv)

summary(sma.int.CV_H)
```


***not significant ***




```{r}
sma.int.CV_H <- sma(log.canopy.V ~ mc.tree_height * rainfall, data=low_mod_cv)

summary(sma.int.CV_H)
```

***not significant***

```{r}
sma.int.CV_H <- sma(log.canopy.V ~ mc.tree_height * rainfall, data= mod_high_cv)

summary(sma.int.CV_H)
```
***significant ***

### elevation test 

```{r}
# Difference in mean centred elevation 

sma.int.H_CV<- with(canopy_volume, method = 'SMA', elev.com(log.canopy.V, mc.tree_height, rainfall))

sma.int.H_CV

```

```{r}
#low mean centred intercept

exp(2.0381954) #mean 
exp(1.6670952) #lower
exp(2.4092957) #upper
```


```{r}
#moderate rainfall 

exp(1.4158239 ) #mean 
exp(1.1540597) #lower
exp(1.6775880) #upper
```


```{r}
# high rainfall 

exp(0.2163242) #mean 
exp(-0.1875999) #lower
exp(0.6202482) #upper
```



### differences in elevation 


```{r}
# Difference in mean centred elevation 

sma.int.H_CV<- with(low_high_cv, method = 'SMA', elev.com(log.canopy.V, mc.tree_height, rainfall))

sma.int.H_CV

```

```{r}
# Difference in mean centred elevation 

sma.int.H_CV<- with(low_mod_cv, method = 'SMA', elev.com(log.canopy.V, mc.tree_height, rainfall))

sma.int.H_CV

```


```{r}
# Difference in mean centred elevation 

sma.int.H_CV<- with(mod_high_cv, method = 'SMA', elev.com(log.canopy.V, mc.tree_height, rainfall))

sma.int.H_CV

```


### visualise CV to H ratio
```{r}
sma.CV_h.test <- sma(log.canopy.V ~ log.tree.H * rainfall, data=canopy_volume)


summary(sma.CV_h.test)
```
```{r}

exp(-25.19155)
exp(-25.00033)
exp(-18.55485)

```


```{r}



CV.H.FUN.L <- function(x) {1.146697e-11 * x^4.559875}

CV.H.FUN.M <- function(x) { 1.388336e-11 * x^4.389392}

CV.H.FUN.H <- function(x) {8.74442e-09 * x^3.182709}
```

392

```{r}
sma.CV.H <- canopy_volume%>%
  ggplot(aes(tree_height, canopy_vol,colour = rainfall))+
  geom_point()+
  geom_function(fun = CV.H.FUN.L, n = 105, colour = "coral2", size = 1)+
  geom_function(fun = CV.H.FUN.M, n = 105, colour = "forestgreen", size = 1)+
  geom_function(fun = CV.H.FUN.H, n = 105, colour =  "deepskyblue3 ", size = 1)+
  ylab(bquote("canopy volume " (m^3)))+
  xlab(bquote("height "(cm^2)))+
  geom_vline(xintercept=392., colour = "goldenrod1", size = 1)+
  ggtitle("C")+
  ylim(0,25)+
  theme_cowplot()+
  theme(axis.title=element_text(size=12), legend.position = "none")
  

print(sma.CV.H)

ggsave("/outputs/tree_stucture/sma.CV.H.png")
```

```{r}
getwd()
```


# PLOT LEVEL METRICS 

## build data set


```{r}

#create subplot level statistics    
  plot_D2h <- D2H_model%>%
  group_by( subplot )%>%
    summarise(
      sub_plot_area = mean(sub_plot_area),
      subplot_density = mean(subplot_density),
      ave.basal = mean(basal_area),
      diameter = mean(diamiter),
      ave.height = mean(height),
      tot.basal = sum(basal_area),
      tot.height = sum(height),
      stem_area = mean(3.1415/4*diamiter^2),
      basal.m2 = tot.basal/sub_plot_area,
      height.m2 = tot.height/sub_plot_area,
      ave.height.m2 = ave.height/sub_plot_area,
      plots = first(plots),
      plot_density = mean(plot_density),
      rainfall = first(rainfall),
      landform = first(landform))%>%
  ungroup()%>%
  mutate(
    logbasal.m2 = log(basal.m2),
    log.sub.dens = log(subplot_density))

summary(plot_D2h)

```










## Plot level basal area/m2 (LMEM) 



```{r}

#compare main effects to interactive model 

final.plot.basal.fit <- lmer(logbasal.m2 ~ rainfall + (1|landform/plots), data = plot_D2h, REML = T)

summary(final.plot.basal.fit)

```




### assumptions

```{r}
qqnorm(residuals(final.plot.basal.fit), pch = 1, frame = FALSE)
qqline(residuals(final.plot.basal.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.plot.basal.fit) ~ fitted(final.plot.basal.fit))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(final.plot.basal.fit)

# Perform the ACF analysis
 acf(residuals)
```

### fixed effect hypothesis testing 

```{r}
final.plot.basal.fit <- lmer(logbasal.m2 ~ rainfall +  (1|landform/plots), data = plot_D2h, REML = F)

final.plot.basal.null <- lmer(logbasal.m2 ~ (1|landform/plots), data = plot_D2h, REML = F)

anova(final.plot.basal.null,final.plot.basal.fit,test = "LRT")
```


***evidence to include rainfall***

### hypothesis testing for random effects





```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.basal.null <- lmer(logbasal.m2 ~ rainfall +  (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.plot.basal.fit <- lmer(logbasal.m2 ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.basal.fit) - 2 * logLik(final.plot.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logBasalSim <- unlist(simulate(final.plot.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logBasalSim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```



***no evidence to include landform***


```{r}
#test if we need  plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.basal.null <- aov(logbasal.m2 ~ rainfall, data = plot_D2h) #null w/o random effect
final.plot.basal.fit <- lmer(logbasal.m2 ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.basal.fit) - 2 * logLik(final.plot.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logBasalSim <- unlist(simulate(final.plot.basal.null)) # resampled data
  bNull <- aov(logBasalSim ~ rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logBasalSim ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```

***evidence to plots and a random effect*** 


## Final Plot level biomass Model

```{r}

final.plot.basal.fit <- lmer(logbasal.m2 ~  rainfall + (1|plots), data = plot_D2h, REML = F)

summary(final.plot.basal.fit)
```


```{r}
#CIs for stand basal area


confint(final.plot.basal.fit)

```



```{r}
#CIs and estimates for stand basal area low

exp(1.8895)     #mean

exp(1.6344626)  #low

exp(2.1412465)  #high 



```


```{r}
#CIs and estimates for stand basal area moderate

exp(1.8895 -0.5214)         #mean

exp(1.6344626 - 0.8883844)  #low

exp(2.1412465 - 0.1649531)  #high 


```



```{r}
#CIs and estimates for stand basal area moderate

exp(1.8895 +  0.2361)       #mean

exp(1.6344626 - 0.1692712)  #low

exp(2.1412465 + 0.6396652)  #high 


```




```{r}
pairs(emmeans(final.plot.basal.fit, ~  rainfall))
```

***sig diff between moderate other sites***



```{r}
stands_basal <-plot_D2h %>%
  ggplot(aes( rainfall, basal.m2, fill = rainfall))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab(bquote("basal area "(cm^2 ~ m^-2)))+
  xlab( "")+
  ggtitle("B")+
  theme_cowplot()+
  theme(legend.position = "none")

print(stands_basal)
```

## final height/m2 (LMEM)


```{r}

#compare main effects to interactive model 

final.plot.height.fit <- lmer(log(height.m2) ~ rainfall + (1|landform/plots), data = plot_D2h, REML = T)

summary(final.plot.height.fit)

```

### assumptions


```{r}
qqnorm(residuals(final.plot.height.fit), pch = 1, frame = FALSE)
qqline(residuals(final.plot.height.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.plot.height.fit) ~ fitted(final.plot.height.fit))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(final.plot.height.fit)

# Perform the ACF analysis
 acf(residuals)
```


### fixed effect hypothesis testing



```{r}
final.plot.height.fit <- lmer(log(height.m2) ~ rainfall +  (1|landform/plots), data = plot_D2h, REML = F)

final.plot.height.null <- lmer(log(height.m2) ~ (1|landform/plots), data = plot_D2h, REML = F)

anova(final.plot.height.null,final.plot.height.fit,test = "LRT")
```
***rainfall significant***






### hypothesis testing for random effects



```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.height.null <- lmer(log(height.m2) ~ rainfall +  (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.plot.height.fit <- lmer(log(height.m2) ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.height.fit) - 2 * logLik(final.plot.height.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logHeightSim <- unlist(simulate(final.plot.height.null)) # resampled data
  bNull <- lmer(logHeightSim ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logHeightSim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```
***landform not significant ***


```{r}
#test if we need plots 

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.height.null <- aov(log(height.m2) ~ rainfall, data = plot_D2h) #null w/o random effect
final.plot.height.fit <- lmer(log(height.m2) ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.height.fit) - 2 * logLik(final.plot.height.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logHeightSim <- unlist(simulate(final.plot.height.null)) # resampled data
  bNull <- aov(logHeightSim ~ rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logHeightSim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```


***plot is significant***

## Final stand height 

```{r}
final.plot.height.fit <- lmer(log(height.m2) ~  rainfall + (1|plots), data = plot_D2h, REML = T)
summary(final.plot.height.fit)

```


```{r}
#CIs for stand height 

confint(final.plot.height.fit)

```


```{r}
#CIs and estimates for stand height low 

exp(3.0543)     # mean 

exp(2.6275736)  # lower

exp(3.4820417)  # upper

```


```{r}
#CIs and estimates for stand height moderate 

exp(3.0543 - 0.8673)     # mean 

exp(2.6275736 - 1.4611559)  # lower

exp(3.4820417 - 0.2754517)  # upper

```


```{r}
#CIs and estimates for stand height high 

exp(3.0543 + 1.2447)     # mean 

exp(2.6275736 + 0.6088990)  # lower

exp(3.4820417 + 1.8830937)  # upper

```



```{r}
pairs(emmeans(final.plot.height.fit, ~ "rainfall"))
```




```{r}
stand_height <-plot_D2h %>%
  ggplot(aes( rainfall, height.m2, fill = rainfall))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab(bquote("height "(cm ~ m^-2)))+
  xlab( "")+
  ggtitle("C")+
  theme_cowplot()+
  theme(legend.position = "none")

print(stand_height)
```

## Stand density model (LMEM)


```{r}
final.density.fit <- lmer(log.sub.dens ~ rainfall + (1|plots), data = plot_D2h, REML = F)

summary(final.density.fit)

confint(final.density.fit)
```


### assumptions


```{r}
qqnorm(residuals(final.density.fit), pch = 1, frame = FALSE)
qqline(residuals(final.density.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.density.fit) ~ fitted(final.density.fit))
```


```{r}
# Extract the residuals from the model
dens.residuals <- residuals(final.density.fit)

# Perform the ACF analysis
 acf(dens.residuals)
 
```


### fixed effect hypothesis testing 


```{r}
final.density.fit <- lmer(log.sub.dens ~ rainfall +  (1|landform/plots), data = plot_D2h, REML = F)

final.density.null <- lmer(log.sub.dens ~ (1|landform/plots), data = plot_D2h, REML = F)

anova(final.density.fit,final.density.null,test = "LRT")
```

***rainfall is significant***

### hypothesis testing for random effects



```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.density.null <- lmer(log.sub.dens ~ rainfall +  (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.density.fit <- lmer(log.sub.dens ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.density.fit) - 2 * logLik(final.density.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logdensitySim <- unlist(simulate(final.density.null)) # resampled data
  bNull <- lmer(logdensitySim ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logdensitySim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```


***no evidence to include landforms as a randome effect***



```{r}
#test if we need plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.density.null <- aov(log.sub.dens ~ rainfall, data = plot_D2h) #null w/o random effect
final.density.fit <- lmer(log.sub.dens ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.density.fit) - 2 * logLik(final.density.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logdensitySim <- unlist(simulate(final.density.null)) # resampled data
  bNull <- aov(log.sub.dens ~ rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logdensitySim ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```





## Final stand density model

```{r}
final.density.fit <- lmer(log.sub.dens ~ rainfall + (1|plots), data = plot_D2h, REML = F)

summary(final.density.fit)

```




```{r}
## CIs and estimates for stand density 


confint(final.density.fit)
```




```{r}

# CIs for low rainfall stand density 


exp( -2.9131 )  # mean 

exp(-3.3674690) # lower 

exp(-2.4532340) # upper 

```



```{r}

# CIs for moderate  rainfall stand density 


exp( -2.9131 - 1.0380)      # mean 

exp(-3.3674690 - 1.6727049) # lower 

exp(-2.4532340 - 0.4103226) # upper 

```


```{r}

# CIs for high rainfall stand density 


exp( -2.9131 +  1.0194)      # mean 

exp(-3.3674690 + 0.3587745) # lower 

exp(-2.4532340 + 1.7050202) # upper 

```





```{r}
pairs(emmeans(final.density.fit, ~ rainfall))
```



```{r}
# Extract the residuals from the model
dens.residuals.fit <- residuals(final.density.fit)

# Perform the ACF analysis
 acf(dens.residuals.fit)
 
```



```{r}

final.tree.density <- plot_D2h%>%
  
  ggplot(aes(rainfall, subplot_density, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab(bquote("tree density "(trees ~ m^-2)))+
  xlab(" ")+
  ggtitle("A")+
  theme_cowplot()+
  theme(legend.position = "none")


print(final.tree.density)
```





## Competition model (LMEM) not sure if worth including ??

```{r}

final.add.competition.model <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|landform /plots), data = plot_D2h, REML = T)

summary(final.add.competition.model)
```

### assumptions

```{r}
vif(final.add.competition.model)
```

```{r}
# Extract the residuals from the model
ave.treebio.residuals.fit <- residuals(final.add.competition.model)

# Perform the ACF analysis
 acf(ave.treebio.residuals.fit)
 
```



```{r}
scatter.smooth(residuals(final.add.competition.model) ~ fitted(final.add.competition.model))
```



### fixed effect hypothesis testing

```{r}
# test significance of rainfall 

final.rainfall.competition.model <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F)

final.rainfall.competition.null <- lmer(log.sub.dens ~ log(ave.basal) + (1|landform/plots), data = plot_D2h, REML = F)

anova(final.rainfall.competition.null, final.rainfall.competition.model)

```


```{r}
# significance of ave.basal 


final.rainfall.competition.null <- lmer(log.sub.dens ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F)

anova(final.rainfall.competition.null, final.rainfall.competition.model)


```


### hypothesis testing for random effects 



final.rainfall.competition.model <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F)


```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.rainfall.compeition.null <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.final.competition.model <- lmer(log.sub.dens ~  log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.final.competition.model) - 2 * logLik(final.rainfall.compeition.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logDensitySim <- unlist(simulate(final.rainfall.compeition.null)) # resampled data
  bNull <- lmer(logDensitySim ~ log(ave.basal) + rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logDensitySim ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```

***landform non significant***


```{r}
nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.rainfall.compeition.null <- aov(log.sub.dens ~ log(ave.basal) + rainfall, data = plot_D2h) #null w/o random effect
final.final.competition.model <- lmer(log.sub.dens ~  log(ave.basal) + rainfall + (1|plots), data = plot_D2h, REML = F) #full model
lrObs <- 2 * logLik(final.final.competition.model) - 2 * logLik(final.rainfall.compeition.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logDensitySim <- unlist(simulate(final.rainfall.compeition.null)) # resampled data
  bNull <- aov(logDensitySim ~ log(ave.basal) + rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logDensitySim ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plot effect

```


***plots are not significant***






## Final competition model fit

```{r}
final.rainfall.compeition.model <- aov(log.sub.dens ~ log(ave.basal) + rainfall, data = plot_D2h)

anova(final.rainfall.compeition.model)
```


```{r}
TukeyHSD(final.rainfall.compeition.model, "rainfall")
```



```{r}
plot_D2h%>%
  ggplot( aes(ave.basal, subplot_density, colour = rainfall))+
  geom_point(aes(shape = landform))+
  geom_smooth(method = "lm", se = F)+
  ylab(bquote("tree density "(tree/m^2)))+
  xlab(bquote("average tree basal area " (cm^2/subplot)))+
  theme_cowplot()+
  theme(legend.position = "none")+
  scale_y_log10()+
  scale_x_log10()

```



```{r}
# Extract the residuals from the model
ave.treebio.residuals.fit <- residuals(final.rainfall.compeition.model)

# Perform the ACF analysis
 acf(ave.treebio.residuals.fit)
 
```







```{r}
vif(final.rainfall.compeition.model)
```



```{r}
plot_D2h%>%
  ggplot( aes(ave.basal, subplot_density, colour = rainfall))+
  geom_point(aes(shape = landform))+
  geom_smooth(method = "lm", se = F)+
  ylab(bquote("tree density "(tree/m^2)))+
  xlab(bquote("individual tree biomass " (kg/subplot)))+
  theme_cowplot()+
  theme(legend.position = "none")+
  scale_y_log10()+
  scale_x_log10()

```






## DIE OFF


## construct data set 

```{r}
library(readr)
noco_deadvalive <- read_csv("input_data/rainfall_data/noco_deadvalive.csv")

```

```{r}
noco_basal <- noco_deadvalive%>%
  gather("d_10", "diamiter", starts_with ("d_"))%>%
  mutate(
    status = as.factor(status),
    basal_area = (diamiter*0.5)^2*3.14159265359)%>%
  arrange(tree)%>%
  filter(!is.na(diamiter))
```


```{r}

noco_tree <- noco_basal%>%
group_by(tree)%>%
  summarise(height = mean(height),
            basal_area = sum(basal_area), 
            status = first(status))%>%
            mutate(
              log.basal = log(basal_area))

summary(noco_tree)

```



## rainfall data 
```{r}
rainfall_history <- read_csv("input_data/rainfall_data/rainfall_history.csv")


an.rainfall <- rainfall_history%>%
  mutate(
  rainfall = as.factor(rainfall),
  rainfall = factor(rainfall, levels = c("low", "moderate", "high")))

f.an.rainfall <- an.rainfall%>%
  filter(year > 1985)

summary(an.rainfall)
```







### Die off model 
```{r}
death.basal<- t.test(log.basal ~ status, mu = 0, data = noco_tree, var.equal = F, alt = "two.sided", paired = F)


print(death.basal)



```

```{r}
#CIs for estimated means die off 


t.test(log.basal ~ 1, conf.level = 0.95, data = subset(noco_tree, status == "a")) # alive trees 

t.test(log.basal ~ 1, conf.level = 0.95, data = subset(noco_tree, status == "d")) # dead trees

```



```{r}
# CIs for alive trees 

exp(5.258036) #mean BA for alive trees

exp(5.065706) #lower

exp(5.450365) #upper 

```




```{r}
# CIs for alive trees 

exp(3.602854) #mean BA for dead trees 

exp(3.392440) #lower

exp(3.813269) #upper

```




```{r}

dead_vs_alive <- noco_tree%>%
  ggplot(aes(status, basal_area, fill = status))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab(bquote("basal area "(cm^2)))+
  xlab("tree status")+
  ggtitle("A")+
  theme_cowplot()+
  theme(legend.position = "none")

 
print(dead_vs_alive)    
#ggsave("outputs/dieback/dead_vs_alive.png")
```
### plot chirps data

```{r}
rainfallTS<- f.an.rainfall%>%
  ggplot( aes(year, annual_precipitation, colour = rainfall))+
  geom_line()+
    ylab("annual precipitation (mm)")+
    xlab("year")+
    ggtitle("B")+
  theme_minimal()+
  theme(legend.position = "none")
  
  
print(rainfallTS) 
#ggsave("outputs/dieback/rainfallTS.png")

```


# FIGURES 

## Trait panel

```{r}
# traits/organs 

plot_grid(vessel.roundness, xylem_area, wood.density, d.massvsarea, leaf.area, nrows =3, ncol=2, rel_widths = c(1,1))


ggsave("outputs/trait/trait_comp.png", width = 12, height =10)

```




## structure panel 

```{r}

plot_grid(sma.basal.vs.heigh_plots, sma_CV_BA, sma.CV.H, basal_area_graph, heightvsrainfall, nrows = 2, ncol = 2, rel_widths = c(1,1))


ggsave("outputs/tree_sturcture/structral_comp.png", width = 10, height = 10)
```



## ecology panel

```{r}

plot_grid(final.tree.density, stands_basal, stand_height, nrows = 2, ncol = 2, rel_widths = c(1,1))


ggsave("outputs/stand/stand_comp.png", width = 12, height = 10)

```

### Die off panel 


```{r}
plot_grid(dead_vs_alive, rainfallTS, nrows = 2, ncol = 1, rel_widths = c(1,1))

ggsave("outputs/dieback/dieoff_comp.png", width = 10, height = 6)
```


