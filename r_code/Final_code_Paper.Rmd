# STATs for Mulga trait shift paper 



# set up

```{r}

library(lme4) #mixed effect linear models

library(MuMIn)

library(lmerTest)

library(emmeans)

library(tidyverse)

library(readr)

library(nlme)

library(ggpmisc)

library(cowplot)

library(car)

library(forcats)

library(msm)

library(mgcv)

library (glmmTMB)

library(sp)

library(gstat)

library(ape)

library(ggpmisc)

library(multcomp)

library(DHARMa)

library(MASS)

library(betareg)

library(glmmTMB)

```


# TRAIT LEVEL METRICS


```{r}
#Plant vessel's Data

#build data set 

vessels <- read_csv("trait_data/vessel.csv")%>%
  mutate(rainfalllow = ifelse (grepl ("STURT", name), "low", "moderate"),
          rainfallhigh = ifelse (grepl ("GUNDA", name), "high", "moderate"),
          landform = ifelse (grepl ("SHED", name), "shed", "acc"),
          rainfall = ifelse(rainfalllow == "low", "low",
                          ifelse(rainfallhigh == "high", "high", "moderate")),
          rainfall = as.factor(rainfall),
         landform = as.factor(landform),
         length = as.numeric(length),
         width = as.numeric(width),
         rainfall = factor(rainfall, levels = c("low", "moderate", "high")))%>%
  
  #extract tree as a grouping factor from the name variable
  
  mutate(
    tree = substr(name, start = 1, stop = 13))%>%
  
  #get log transformations of various variables
  mutate(log.roundness = log(roundess),
         log.area = log(area))
 
  
  f.vessels <- vessels%>% 
    filter(, l_ratio > 0.20)%>%
    filter(, roundess > 0.15)%>%
    filter(, area < 3000)%>%
    filter(, area > 60)%>%
    filter(, width > 3)%>%
     
  #turn point values into area (pixel spacial resolution 1.17um across images on average with small variance (total range = 0.014um))
  mutate(area = 1.17*area,
         length = 1.17*length,
         width = 1.17*width,
         perimeter = 1.17*perimeter)


  summary(vessels)


```




```{r}

#leaf data 

total_leaves <- read_csv("trait_data/leaves/total_leaves.csv")%>%
  mutate( rainfall = factor(rainfall, levels = c("low", "moderate", "high")))


summary(total_leaves)

```




```{r}
trait_SLA <- total_leaves%>%
  mutate(
    tree_number = as.factor(tree_number),
    #cm^2/mg
    sla = leaf_area/leaf_mass,
    volume = leaf_area * leaf_thickness
    )%>%
  arrange(tree_number)%>%
  filter(!is.na(sla))%>%
  aggregate(sla~tree_number + landform + volume + leaf_area + leaf_thickness  + leaf_mass + wood_density + rainfall,mean)

summary(trait_SLA)
```

```{r}
# Wood density data

total_wood <- read_csv("~/Thesis/r_studio/trait_data/wood/total_wood.csv")%>%
  mutate( rainfall = factor(rainfall, levels = c("low", "moderate", "high")))


summary(total_wood)

```


```{r}

wood_data <- total_wood%>%
  mutate(
    basal_area = (wood_thickness*0.5)^2*3.14159265359,
    volume = basal_area * wood_length,
    wood.dens = wood_mass/volume)

summary(wood_data)

```



## Vessel roundness model (GLMM)


```{r}

lmem.roundness <- lmer(log.roundness ~ rainfall  + (1|tree), data = f.vessels)

summary(lmem.roundness)
```

```{r}
## coefficent of variance


confint(lmem.roundness)
```


```{r}

## low rainfall estimates and CI roundness 
exp(-1.0185754)

exp(-0.8230986)

exp(-0.92086)
```

```{r}

# high rinfall estimates and CI roundenss
exp(-1.0185754 -0.1319110)

exp(-0.8230986  + 0.2168832)

exp(-0.92086 + 0.04248)
```




### Assumptions

```{r}

lmem.roundness <- lmer(log.roundness ~ rainfall + landform + (1|tree), data = f.vessels)

summary(lmem.roundness)

```



```{r}

scatter.smooth(residuals(lmem.roundness) ~ fitted(lmem.roundness))
```

```{r}
qqnorm(residuals(lmem.roundness), pch = 1, frame = FALSE)
qqline(residuals(lmem.roundness), col = "steelblue", lwd = 2)
```

***distributional assumptions not met find a new model***

```{r}
# Extract the residuals from the model
residuals <- residuals(lmem.roundness)

# Perform the ACF analysis
 acf(residuals)
```
### compare GLM with various distributional assumptions
```{r}
vessels%>%
  ggplot( aes(x = roundess))+
  geom_histogram()+
  ggtitle("vessel roundess distribution")
  
```
***fits beata distribution the best***



```{r}

gamma.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = Gamma())

beta.glmm.roundness <- glmmTMB(roundess ~ rainfall  + (1|landform/tree), data = f.vessels,family = beta_family())

anova(gamma.glmm.roundness, beta.glmm.roundness, test = "LRT")

```


```{r}
possion.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = poisson())

anova(beta.glmm.roundness, possion.glmm.roundness, test = "LRT")
```



```{r}

lmem.roundness <- lmer(log.roundness ~ rainfall + (1|landform/tree), data = f.vessels)

beta.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels, family = beta_family())

# Compare the models using likelihood ratio test (LRT)
anova(lmem.roundness, beta.glmm.roundness, test = "LRT")

```


```{r}

scatter.smooth(residuals(beta.glmm.roundness) ~ fitted(beta.glmm.roundness))
```



```{r}
beta.roundness.SimRes <- simulateResiduals(fittedModel  = beta.glmm.roundness)

plot(beta.roundness.SimRes)

```




```{r}
summary(beta.glmm.roundness)
```



***glmm with beta distribution best***



***rainfall not significant***




### fixed effect hypothesis testing 

```{r}
beta.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = beta_family())

beta.glmm.roundness.null <- glmmTMB(roundess ~ (1|landform/tree), data = f.vessels,family = beta_family())

anova(beta.glmm.roundness, beta.glmm.roundness.null, test = "chisq")
```

***rainfall not significant***
```{r}
vessel.roundness <- ggplot( f.vessels, aes(rainfall, roundess, fill = rainfall))+
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("a")+
  ylab ("xylem roundness")+
  xlab("rainfall site")+
  theme(legend.position = "none")

print(vessel.roundness)

```




```{r}
mean(f.vessels$roundess)
```



## Vessel area model (LMEM)

```{r}

area.model <- lmer(log.area ~ rainfall +  (1|tree), REML = T, data = f.vessels)

summary(area.model)

```






### assumptions





```{r}


qqnorm(residuals(area.model), pch = 1, frame = FALSE)
qqline(residuals(area.model), col = "steelblue", lwd = 2)
#plot(area.model, which = 2)


```

```{r}

scatter.smooth(residuals(area.model) ~ fitted(area.model))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(area.model)

# Perform the ACF analysis
 acf(residuals)
```

### fixed effect hypothesis testing 


```{r}
area.model <- lmer(log.area ~ rainfall +  (1|tree), REML = T, data = f.vessels)
area.model.null <- lmer(log.area ~  (1|tree), REML = T, data = f.vessels)


anova(area.model, area.model.null, test = "LRT")
```

***rainfall not significant***




```{r}
 area.model<- lmer(log.area ~ rainfall +  (1|tree), REML = T, data = f.vessels)

summary(area.model)

```


```{r}
#confidence intervals 


confint(area.model)
```


```{r}
#low rainfall vessel area
 
exp(5.86992556) # lower

exp(6.012841221) # upper 

exp(5.94151)    #mean
```



```{r}
#moderate rainfall vessel area


exp(5.86992556 - 0.20654292) #lower 

exp(6.012841221 -  0.003794794) # upper 

exp(5.94151 - 0.10507 )  #mean 


```





```{r}
#diamiter
ggplot(f.vessels, aes(log.area, colour = rainfall)) +
  geom_histogram()

xylem_area <- ggplot( f.vessels, aes(rainfall, area, fill = rainfall))+
  geom_boxplot()+
  theme_cowplot()+
  scale_y_log10()+
  ggtitle("B")+
  ylab(bquote("xylem area " (Î¼m^2)))+
  xlab("rainfall site")+
  theme(legend.position = "none")

print(xylem_area)

```



```{r}
mean(f.vessels$area)
```


## Wood denisty model 

```{r}

wood.dens.aov <- aov(log(wood.dens) ~ rainfall, data = wood_data)

summary(wood.dens.aov)

```



```{r}

qqnorm(residuals(wood.dens.aov), pch = 1, frame = FALSE)
qqline(residuals(wood.dens.aov), col = "steelblue", lwd = 2)

```



```{r}
plot(wood.dens.aov, which = 1)
```


```{r}
# Extract the residuals from the model
residuals <- residuals(wood.dens.aov)

# Perform the ACF analysis
 acf(residuals)
```


### fixed effect hypothesis testing 

```{r}

log.wood.dens.aov <- aov(log(wood.dens) ~ rainfall, data = wood_data, )


summary(log.wood.dens.aov)

```

```{r}

### estimates and CIs for wood density 

coef(log.wood.dens.aov)

confint(log.wood.dens.aov)
```


```{r}
## CIs for wood density low

exp(-0.12803192) #mean 

exp(-0.17401344) #lower

exp(-0.08205040) #upper

```


```{r}
## CIs for wood density moderate 

exp(-0.12803192 - 0.03583338) #mean 

exp(-0.17401344 - 0.10209981) #lower

exp(-0.08205040 + 0.03043304) #upper

```





***rainfall not significant***

```{r}

wood.density <- wood_data%>%
  ggplot(aes(rainfall, wood.dens, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab(bquote("wood density " (g ~ cm^-3)))+
  theme_cowplot()+
  xlab(" ")+
  ggtitle("C")+
  theme(legend.position = "none")


print(wood.density)

```

```{r}
mean(wood_data$wood.dens)
```



```{r}
# Extract the residuals from the model
residuals <- residuals(wood.dens.aov)

# Perform the ACF analysis
 acf(residuals)
```







## SLA model 

`

```{r}
SLA.anova <- aov(log(sla) ~  rainfall, data = trait_SLA)

```



```{r}

qqnorm(residuals(SLA.anova), pch = 1, frame = FALSE)
qqline(residuals(SLA.anova), col = "steelblue", lwd = 2)

```


```{r}
plot(SLA.anova, which = 1)
     
```


```{r}
# Extract the residuals from the model
residuals <- residuals(SLA.anova)

# Perform the ACF analysis
 acf(residuals)
```





### Final SLA model fit

```{r}
SLA.anova <- aov(log(sla) ~  rainfall, data = trait_SLA)


TukeyHSD(SLA.anova)


summary(SLA.anova)
```



```{r}
TukeyHSD(SLA.anova)
```



```{r}
# estimates of CI for SLA 

coef(SLA.anova)

confint(SLA.anova)
```

```{r}
## CIs for MLA low rainfall 


exp(-4.0286620) #mean 

exp(-4.1330780) #lower

exp(-3.9242460) #upper


```


```{r}
## CIs for MLA moderate rainfall 


exp(-4.0286620 + 0.3664057) #mean 

exp(-4.1330780 +  0.2245323) #lower

exp(-3.9242460 +  0.5082791) #upper


```


```{r}
## CIs for MLA high rainfall 


exp(-4.0286620 +  0.6658169) #mean 

exp(-4.1330780 +  0.5212595  ) #lower

exp(-3.9242460 +  0.8103743) #upper


```



```{r}

d.massvsarea <- trait_SLA%>%
  ggplot(aes(rainfall, sla, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab(bquote("LMA" ~ (cm^2 ~ mg^-1)))+
  xlab("   ")+
  ggtitle("D")+ 
  theme_cowplot()+
  theme(legend.position = "none")

print(d.massvsarea)

#ggsave("d.massvsarea.png")

```

```{r}
plot(SLA.anova, which = 1)
```









## Leaf area 

```{r}

leaf_area.aov <- aov(log(leaf_area) ~  rainfall, data = trait_SLA)

summary(leaf_area.aov)

TukeyHSD(leaf_area.aov)

```




```{r}
qqnorm(residuals(leaf_area.aov), pch = 1, frame = FALSE)
qqline(residuals(leaf_area.aov), col = "steelblue", lwd = 2)

```


```{r}
plot(leaf_area.aov, which = 1)
     
```


}
```{r}

# Extract the residuals from the model
residuals <- residuals(leaf_area.aov)

# Perform the ACF analysis
 acf(residuals)
```











# INDIVIUDAL TREE LEVEL METRICS

## build data sets

### import/build data set



```{r}
total_plots <- read_csv("plot_data/total_plots.csv")%>%
  mutate(
   landform = as.factor(landform),

    plots = as.factor(plots),
   
   subplot = as.factor(subplot),

    rainfall = factor(rainfall, levels = c("low", "moderate" , "high")))

summary(total_plots)
```



```{r}
total_wood <- read_csv("~/Thesis/r_studio/trait_data/wood/total_wood.csv")%>%
  mutate( rainfall = factor(rainfall, levels = c("low", "moderate", "high")))


summary(total_wood)

```


### calcuale basal area and summed biomass



```{r}

 #calculate basal area   
  basal_area <- total_plots %>%
  gather("d_10", "diamiter", starts_with ("d_"))%>%
  mutate(basal_area = (diamiter*0.5)^2*3.14159265359)%>%
  arrange(tree)%>%
  filter(!is.na(diamiter))
```

### biomass estimates for individual trees


```{r}
  
 # using the accacia allometric equation from feller 1980 we will calculate biomass for each tree based on a "stem by stem" analysis.
# see "Review of Allometric Relationships for Estimating Woody Biomass for New South Wales, the Australian Capital Territory, Victoria, Tasmania and South Australia" (page 36)
    D2H_model <- basal_area %>%
   group_by(tree, height, landform, plots, rainfall, subplot, sub_plot_area, subplot_density, plot_density)%>%
  summarise(basal_area = sum(basal_area),.groups = "drop")%>%
      mutate(diamiter = (sqrt(basal_area/3.14159265359))*2)

```




### filtered 

```{r}
#filter out smaller trees due to allometeric differences in juveniles

f.D2H_model <- filter(D2H_model, diamiter > 2) 

f.h.D2H_model <- filter(f.D2H_model, height > 40)


```



### allometric data with canopy volume

```{r}

allometry_total <- read_csv("allometry/allometry_total.csv")%>%
 mutate(
   landform = as.factor(landform),

    rainfall = factor(rainfall, levels = c( "low", "moderate", "high")))

summary(allometry_total)

```



### calculate basal area and canopy volume



```{r}

#calcualte basal area
allo_basal <- allometry_total %>%
  gather("d10", "diamiter", starts_with ("d10"))%>%
  mutate(basal_area = (diamiter*0.5)^2*3.14159265359)%>%
  arrange(tree)%>%
  filter(!is.na(diamiter))


```





```{r}

canopy_volume <- allo_basal%>%
  group_by(tree, canopy_1, canopy_2, `95_Canopy`, tree_height, landform, rainfall)%>%
  summarise(basal_area = sum(basal_area),.groups = "drop")%>%
  mutate(canopy_height = ((tree_height - `95_Canopy`)/2),  # divide by 2 to get the semi-axis
         canopy_length = canopy_1/2,
         canopy_bredth = canopy_2/2,
         canopy_vol= (3/4 * 3.141593 * canopy_height *canopy_bredth * canopy_length)/1000000,# volume of an ellipsoid. Divide by 1,000,000 to get m3
         log.tree.H = log(tree_height),
         log.canopy.V = log(canopy_vol),
         log.basal_area = log(basal_area),
         cent.log.h = log.tree.H - 1.641818,
         cent.log.b = log.basal_area -4.924167)%>%
  filter(!is.na(canopy_vol))%>%
  filter(!is.na(log.canopy.V))

  

```

```{r}
mean(canopy_volume$log.tree.H)

mean(canopy_volume$log.basal_area)

```



```{r}

summary(canopy_volume)

```

***canopy volume is within standard estimates of mature trees from other studies "Canopy Area and Aboveground Mass of Individual Redberry Juniper"*****


## Basal area (LMEM)


```{r}

final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot), data = f.D2H_model, REML = T)

summary(final.basal.fit)



```
### assumptions

```{r}
qqnorm(residuals(final.basal.fit), pch = 1, frame = FALSE)
qqline(residuals(final.basal.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.basal.fit) ~ fitted(final.basal.fit))
```


```{r}
# Extract the residuals from the model
basal.residuals <- residuals(final.basal.fit)

# Perform the ACF analysis
 acf(basal.residuals)
```
### fixed effect hypothesis testing 


final.height.basal.aov <- lmer(log(height) ~ log(basal_area) * rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F)
final.height.null <- lmer(log(height) ~ log(basal_area) + (1|landform/plots/subplot), data = f.D2H_model, REML = F)

anova(final.height.null,final.height.basal.aov,test = "LRT")


```{r}
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|landform/plots/subplot), data = f.D2H_model, REML = F)

final.basal.null <- lmer(log(basal_area) ~  (1| landform/plots/subplot), data = f.D2H_model, REML = F)

anova(final.basal.null, final.basal.fit, test = "LRT")
```


### random effect hypothesis testing 

```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.basal.null <- lmer(log(basal_area) ~  rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) #null model
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.basal.fit) - 2 * logLik(final.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logBasalSim <- unlist(simulate(final.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~  rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logBasalSim ~ rainfall + (1 | landform/plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```



```{r}
#test if we need plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.basal.null <- lmer(log(basal_area) ~  rainfall + (1|subplot) , data = f.D2H_model, REML = F) #null model
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.basal.fit) - 2 * logLik(final.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logBasalSim <- unlist(simulate(final.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~  rainfall + (1 |subplot), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logBasalSim ~ rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```
***plots significant***





```{r}
#test if we need landform given we have subplots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.basal.null <- lmer(log(basal_area) ~  rainfall + (1|plots) , data = f.D2H_model, REML = F) #null model
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.basal.fit) - 2 * logLik(final.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logBasalSim <- unlist(simulate(final.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~  rainfall + (1 | plots), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logBasalSim ~ rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```


***subplot significant***

##Final Basal area fit

pairs(emmeans(final.height.basal.lm, ~  rainfall))

```{r}
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot) , data = f.D2H_model, 
                        control = lmerControl(optimizer ="Nelder_Mead"),
                        REML = T) 


summary(final.basal.fit)

```


```{r}
## estimates and CIs

confint(final.basal.fit)


```


```{r}
#tree basal area low

exp(4.4303) #mean 

exp(3.90266145) # lower

exp(4.95789700) # upper

```


```{r}
#tree basal area mod

exp(4.4303 + 0.7051) #mean 

exp(3.90266145 - 0.01953386) # lower

exp(4.95789700 + 1.42965397) # upper

```



```{r}
#tree basal area high

exp(4.4303 - 0.8352) #mean 

exp(3.90266145 - 1.58930898) # lower

exp(4.95789700 - 0.08227804) # upper

```




```{r}
pairs(emmeans(final.basal.fit, ~ "rainfall"))
```





```{r}

b.a_graph <- f.D2H_model %>%
  ggplot(aes(rainfall, basal_area, fill = rainfall))+
  geom_boxplot( notch = F)+
  scale_y_log10()+
  ggtitle("D")+
  ylab(bquote("basal area "(cm^2)))+
  xlab("rainfall")+
  theme_cowplot()+
  theme(legend.position = "none")

print(b.a_graph)


```






## Basal area to height (LMEM)



```{r}
#the interaction term (*) between log(basal_area) and rainfall allows the "height Vs basal areas" relationship to vary between levels of rainfall (or across sites). 

final.height.basal.lm <- lmer(log(height) ~ log(basal_area) * rainfall + (1|plots/subplot), data = f.D2H_model, REML = T)

summary(final.height.basal.lm)
confint(final.basal.fit)


```

### assumptions
```{r}
qqnorm(residuals(final.height.basal.lm), pch = 1, frame = FALSE)
qqline(residuals(final.height.basal.lm), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.height.basal.lm) ~ fitted(final.height.basal.lm))
```





```{r}
vif(final.height.basal.lm)
```



```{r}
# Extract the residuals from the model
height.basal.residuals <- residuals(final.height.basal.lm)

# Perform the ACF analysis
 acf(height.basal.residuals)
```


### fixed effect hypothesis testing

```{r}
# null vs fit

final.height.basal.aov <- lmer(log(height) ~ log(basal_area) * rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F)
final.height.null <- lmer(log(height) ~ log(basal_area) + (1|landform/plots/subplot), data = f.D2H_model, REML = F)

anova(final.height.null,final.height.basal.aov,test = "LRT")

```




### hypothesis testing for random effects

```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.height.basal.null <- lmer(log(height) ~ log(basal_area) * rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) #null model
final.height.basal.aov <- lmer(log(height) ~ log(basal_area) * rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.height.basal.aov) - 2 * logLik(final.height.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logHeightSim <- unlist(simulate(final.height.basal.null)) # resampled data
  bNull <- lmer(logHeightSim ~ log(basal_area) * rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logHeightSim ~ log(basal_area) * rainfall + (1 | landform/plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```


```{r}
#test if we need subplots given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.height.basal.null <- lmer(log(height) ~ log(basal_area) * rainfall + (1|plots) , data = f.D2H_model, REML = F)
final.height.basal.aov <- lmer(log(height) ~ log(basal_area) * rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.height.basal.aov) - 2 * logLik(final.height.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logHeightSim <- unlist(simulate(final.height.basal.null)) # resampled data
  bNull <- lmer(logHeightSim ~ log(basal_area) * rainfall + (1 | plots), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logHeightSim ~ log(basal_area) * rainfall + (1 |plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```





## Final Basal area to height model 

```{r}
final.height.basal.lm <- lmer(log(height) ~ log(diamiter) * rainfall + (1|plots/subplot) , data = f.D2H_model, REML = T)

summary(final.height.basal.lm)
```

```{r}
r.squaredGLMM(final.height.basal.lm)
```



```{r}
anova(final.height.basal.lm)
```





```{r}
#difference in means 

pairs(emmeans(final.height.basal.lm, ~  rainfall))


```



```{r}

#confidence intervals for the slopes across 

confint(final.height.basal.lm)
```

```{r}
#low exponent 

0.30393       # mean 
0.266270622   # lower
0.34194088    # upper

```

```{r}
#mod exponent

0.30393 + 0.07966            # mean 
0.266270622  + 0.009957548   # lower
0.34194088 + 0.14891702      # upper

```


```{r}
#high exponent

0.30393 + 0.30680           # mean
0.266270622 +  0.256698255  # lower
0.34194088 + 0.35643309     # upper

```



```{r}
# CIs for the low rainfall intercept 

exp(5.25929) # mean 

exp(5.115274651) #lower 

exp(5.40318628) #upper

```



```{r}
# CIs for the mod rainfall intercept 

exp(5.25929  - 0.09137) # mean 

exp(5.11527465 -0.328163516) #lower 

exp(5.40318628 + 0.14623778) #upper

```



```{r}
# CIs for the high rainfall intercept 

exp(5.25929  -0.20589) # mean 

exp(5.11527465 -0.401401407) #lower 

exp(5.40318628  -0.01027659) #upper

```




```{r}
#functions for BA Vs H 


H.BA.FUN.L <- function(x) { 192.3449 * x^0.30393}

H.BA.FUN.M <- function(x) { 175.5493 * x ^0.38359 }

H.BA.FUN.H <- function(x) {156.5538 * x^0.61073}


```



  geom_function(fun = CV.H.FUN.L, n = 105, colour = "red", size = 1)+
  geom_function(fun = CV.H.FUN.M, n = 105, colour = "forestgreen", size = 1)+
  geom_function(fun = CV.H.FUN.H, n = 105, colour =  "deepskyblue3 ", size = 1)+

```{r}
basal.vs.heigh_plots <- f.D2H_model%>%
  ggplot(aes(diamiter, height, colour = rainfall))+
  geom_point(aes(shape = landform))+
  geom_function(fun = H.BA.FUN.L, n = 105, colour = "red", size = 1)+
  geom_function(fun = H.BA.FUN.M, n = 105, colour = "forestgreen", size = 1)+
  geom_function(fun = H.BA.FUN.H, n = 105, colour =  "deepskyblue3 ", size = 1)+
  ylab("height (cm)")+
  xlab("diameter (cm)")+
  ggtitle("A")+
  #scale_x_log10()+
  #scale_y_log10()+
  theme_cowplot()+
  theme(axis.title=element_text(size=12), legend.position = "none")
  

print(basal.vs.heigh_plots)

#ggsave("basal.vs.height_plots.png")

```



glmmTMB(height ~ rainfall + (1|plots/subplot), data = f.D2H_model,family = gaussian(link = "identity"))
## Tree height (GLMM)

```{r}
final.tree.height.lm <- lmer(log(height) ~  rainfall + (1|plots/subplot), data = f.D2H_model, REML = F)

summary(final.tree.height.lm)

```






```{r}

final.tree.height.lm <- lmer(log(height) ~  rainfall + (1|plots/subplot), data = f.D2H_model, REML = F)

final.tree.height.lm.null <- lmer(log(height) ~  (1|plots/subplot), data = f.D2H_model, REML = F)

anova(final.tree.height.lm.null, final.tree.height.lm, test = "LRT")
```




```{r}
pairs(emmeans(final.tree.height.lm, ~ rainfall))
```





### assumptions

```{r}

qqnorm(residuals(final.tree.height.lm), pch = 1, frame = FALSE)
qqline(residuals(final.tree.height.lm), col = "steelblue", lwd = 2)


```



```{r}
scatter.smooth(residuals(final.tree.height.lm) ~ fitted(final.tree.height.lm))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(final.tree.height.lm)

# Perform the ACF analysis
 acf(residuals)
```
***fit diagnostics indicates violation of the distributional assumptions***



### GLMM height model 


```{r}
ggplot(f.D2H_model, aes(height, colour = rainfall)) +
  geom_histogram()+
  scale_x_log10()

```


```{r}
height.GLMM.gamma <- glmmTMB(height ~ rainfall + (1|plots/subplot), data = f.D2H_model,family = Gamma(link = "log"))

height.glmm.norm <- glmmTMB(height ~ rainfall + (1|plots/subplot), data = f.D2H_model,family = gaussian(link = "identity"))

summary(height.GLMM.gamma)
#summary(height.glmm.norm)
```




```{r}
confint(height.GLMM.gamma)

```

```{r}
# estimates for low rainfall height 

exp(5.835619826)
exp(6.1587349)
exp(5.9971773)
```


```{r}
# estiamtes for moderate 


exp(5.835619826 + 0.007713873)
exp(6.1587349 + 0.4520716)
exp(5.9971773 + 0.2298927)

```


```{r}
# high rainfall 


exp(5.835619826 +  0.075209160)
exp(6.1587349 + 0.5371835)
exp(5.9971773 + 0.3061963)

```


```{r}

height.emm<- pairs(emmeans(height.GLMM.gamma, ~ rainfall))
summary(height.emm)

```

```{r}
confint(height.emm)
```

```{r}
exp(-0.3062)
exp(-0.582)
exp(-0.0300)
```



```{r}
gamma.height.SimRes <- simulateResiduals(fittedModel  = height.GLMM.gamma)

plot(gamma.height.SimRes)
```



final.tree.height.lm


```{r}
norm.height.SimRes <- simulateResiduals(fittedModel  = height.glmm.norm)

plot(norm.height.SimRes)
```



```{r}
# Extract the residuals from the model
residuals <- residuals(final.tree.height.lm)

# Perform the ACF analysis
 acf(residuals)
```


```{r}
durbinWatsonTest(residuals)

```



### fixed effect hypothesis testing 



```{r}
height.GLMM.gamma <- glmmTMB(height ~ rainfall + (1|plots/subplot), data = f.D2H_model,family = Gamma(link = "log"))

height.GLMM.gamma.null <- glmmTMB(height ~  (1|plots/subplot), data = f.D2H_model,family = Gamma(link = "log"))

anova(height.GLMM.gamma.null, height.GLMM.gamma, test = "Chisq")
```
```{r}

```




```{r}
pairs(emmeans(height.GLMM.gamma, ~ rainfall))
```



```{r}

heightvsrainfall <- f.D2H_model%>%
  ggplot( aes( rainfall, height, fill = rainfall))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab("height (cm)")+
  xlab(" ")+
  ggtitle("E")+
  theme_cowplot()+
   theme(legend.position = "none")
  

print(heightvsrainfall)

```









## Canopy volume vs height (ANCOVA)



```{r}

final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = T)

summary(final.canopy.height.fit)

```


### assumptions
```{r}
qqnorm(residuals(final.canopy.height.fit ), pch = 1, frame = FALSE)
qqline(residuals(final.canopy.height.fit ), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.canopy.height.fit ) ~ fitted(final.canopy.height.fit ))
```


```{r}
# Extract the residuals from the model
cv.residuals <- residuals(final.canopy.height.fit )

# Perform the ACF analysis
 acf(cv.residuals)
```



```{r}
vif(final.canopy.height.fit)
```







### fixed effect hypothesis testing 


```{r}
# significance of rainfall

final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = F)
final.canopy.height.null <- lmer(log.canopy.V ~ log.tree.H + (1|landform), data = canopy_volume, REML = T)

anova(final.canopy.height.null,final.canopy.height.fit,test = "LRT")

```

```{r}
# significance of height

final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = F)
final.canopy.height.null <- lmer(log.canopy.V ~ rainfall + (1|landform), data = canopy_volume, REML = T)

anova(final.canopy.height.null,final.canopy.height.fit,test = "LRT")

```

### structural sensitivity analysis


```{r}
# significance of interaction effect

final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H * rainfall + (1|landform), data = canopy_volume, REML = F)
final.canopy.height.null <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = T)

anova(final.canopy.height.null,final.canopy.height.fit,test = "LRT")

```

***do not include interactive effect***



### hypothesis testing for ranodm effect

```{r}
#test if we need landform as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.canopy.height.null <- aov(log.canopy.V ~ log.tree.H + rainfall, data = canopy_volume) #null w/o random effect
final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = F) # full model
lrObs <- 2 * logLik(final.canopy.height.fit) - 2 * logLik(final.canopy.height.null) # observed test stat
for (iBoot in 1:nBoot)
{
  canopy_volume$logCanopySim <- unlist(simulate(final.canopy.height.null)) # resampled data
  bNull <- aov(logCanopySim ~ log.tree.H + rainfall, data = canopy_volume) # null model
  bAlt <- lmer(logCanopySim ~ log.tree.H + rainfall + (1 |landform), data = canopy_volume, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```
***no evidence to include landform***

## Final Canopy Volume vs Hight model


```{r}
final.canopy.height.aov <- aov(log.canopy.V ~ cent.log.h * rainfall , data = canopy_volume)


```



```{r}
vif(final.canopy.height.aov, terms = 'high-order')
```



```{r}
# Extract the residuals from the model
cv.residuals <- residuals(final.canopy.height.aov)

# Perform the ACF analysis
 acf(cv.residuals)
```

```{r}
final.canopy.height.aov <- aov(log.canopy.V ~ cent.log.h * rainfall , data = canopy_volume)

Anova(final.canopy.height.aov, type="III") 

```

***non significant interaction = no change in slope***

```{r}
final.canopy.height.aov <- lm(log.canopy.V ~ log.tree.H + rainfall , data = canopy_volume)

summary(final.canopy.height.aov)


#TukeyHSD(final.canopy.height.aov, "rainfall")
```



```{r}

#estimates and CIs for canopy vs height 

coef(final.canopy.height.aov)

confint(final.canopy.height.aov)

```



```{r}
## canopy vs height CIs for low rainfall 

exp( -15.4176)  # mean 

exp(-17.8314296  )  # lower

exp(-13.0037127) # upper 
```

```{r}
## canopy vs height CIs for moderate rainfall 

exp(-15.4176 -0.2690 )  # mean 

exp(-17.8314296 -0.7146088)  # lower

exp(-13.0037127 + 0.1766841 ) # upper 
```

```{r}
## canopy vs height CIs for high rainfall 

exp(-15.4176  -1.4992 )  # mean 

exp(-17.8314296 -1.9384544)  # lower

exp(-13.0037127 -1.0598549) # upper
```



```{r}

# define Canopy area to height area function from above ANCOVA 

CV.H.FUN.L <- function(x) { 0.0000002014751 * x^2.9235}

CV.H.FUN.M <- function(x) { 0.0000001539558 * x ^2.9235 }

CV.H.FUN.H <- function(x) {0.00000004499115 * x^2.9235}
```


```{r}
canopyvsheight <- canopy_volume %>%
  ggplot(aes(tree_height,canopy_vol, colour = rainfall)) +
  geom_point()+
  geom_function(fun = CV.H.FUN.L, n = 105, colour = "red", size = 1)+
  geom_function(fun = CV.H.FUN.M, n = 105, colour = "forestgreen", size = 1)+
  geom_function(fun = CV.H.FUN.H, n = 105, colour =  "deepskyblue3 ", size = 1)+
  #scale_x_log10()+
  #scale_y_log10()+
  ylab( bquote("canopy volume " (m^3)))+
  xlab( bquote( "height " (cm^2)))+
  ggtitle("C")+
  theme_cowplot()

print(canopyvsheight)

```



## Canopy volume vs basal area (ANCOVA)



```{r}

final.canopy.basal.fit <- lm(log.canopy.V ~ cent.log.b * rainfall, data = canopy_volume)

Anova(final.canopy.basal.fit)
```


*****no diff in slope*******


```{r}

final.canopy.basal.fit <- lm(log.canopy.V ~ log.basal_area + rainfall, data = canopy_volume)

summary(final.canopy.basal.fit)
```
```{r}
exp(-3.56277) # scaling factor low 

exp(-3.56277 + 0.11422)# moderate 

exp(-3.56277 + 0.20705) #high 

```




```{r}

confint(final.canopy.basal.fit)

```



### assumptions 

```{r}
qqnorm(residuals(final.canopy.basal.fit ), pch = 1, frame = FALSE)
qqline(residuals(final.canopy.basal.fit ), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.canopy.basal.fit ) ~ fitted(final.canopy.basal.fit ))
```


```{r}
# Extract the residuals from the model
cb.residuals <- residuals(final.canopy.basal.fit )

# Perform the ACF analysis
 acf(cb.residuals)
```

```{r}
vif(final.canopy.basal.fit)
```

**********************testing parameterized function*********************************

```{r}

# define Canopy area to basal area function from above ANCOVA 

CV.BA.FUN.L <- function(x) { 0.028360* x^1.14}

CV.BA.FUN.M <- function(x) { 0.0317917 * x ^1.14 }

CV.BA.FUN.H <- function(x) {0.03488424 * x^1.14}
```


  
  
  

```{r}
canopyvsbasal <- canopy_volume %>%
  ggplot(aes(basal_area,canopy_vol, colour = rainfall)) +
  geom_point()+
  geom_function(fun = CV.BA.FUN.L, n = 105, colour = "red", size = 1)+
  geom_function(fun = CV.BA.FUN.M, n = 105, colour = "forestgreen", size = 1)+
  geom_function(fun = CV.BA.FUN.H, n = 105, colour =  "deepskyblue3 ", size = 1)+
  #scale_x_log10()+
  #scale_y_log10()+
  ylab( bquote("canopy volume " (m^3)))+
  xlab( bquote( "basal area " (cm^2)))+
  ggtitle("B")+
  theme_cowplot()

print (canopyvsbasal)

```






### fixed effect hypothesis testing


```{r}

final.canopy.basal.fit <- lmer(log.canopy.V ~ cent.tree.b + rainfall + (1|landform), data = canopy_volume, REML = F)

final.canopy.basal.null <- lmer(log.canopy.V ~ cent.tree.b + (1|landform), data = canopy_volume, REML = F)

anova(final.canopy.basal.null,final.canopy.basal.fit,test = "LRT")
```

```{r}
final.canopy.basal.null <- lmer(log.canopy.V ~ rainfall + (1|landform), data = canopy_volume, REML = F)

anova(final.canopy.basal.null,final.canopy.basal.fit,test = "LRT")
```
***rainfall not significant!!***






```{r}

basalvscanopy <- canopy_volume%>%
  ggplot( aes( basal_area, canopy_volume, colour = rainfall))+
  geom_point(aes(shape = landform))+
     geom_smooth(method = "lm",
                 se = F)+
  ylab(bquote("canopy volume " (m^3)))+
  xlab(bquote("basal area " (cm^2)))+
  scale_x_log10()+
  scale_y_log10()+
  ggtitle("B")+
  theme_cowplot()+
  theme(axis.title=element_text(size=12,face="bold"))+
  theme(legend.position = "none")
  


 print(basalvscanopy)
```






# PLOT LEVEL METRICS 

## build data set


```{r}

#create subplot level statistics    
  plot_D2h <- D2H_model%>%
  group_by( subplot )%>%
    summarise(
      sub_plot_area = mean(sub_plot_area),
      subplot_density = mean(subplot_density),
      ave.basal = mean(basal_area),
      diameter = mean(diamiter),
      ave.height = mean(height),
      tot.basal = sum(basal_area),
      tot.height = sum(height),
      stem_area = mean(3.1415/4*diamiter^2),
      basal.m2 = tot.basal/sub_plot_area,
      height.m2 = tot.height/sub_plot_area,
      ave.height.m2 = ave.height/sub_plot_area,
      plots = first(plots),
      plot_density = mean(plot_density),
      rainfall = first(rainfall),
      landform = first(landform))%>%
  ungroup()%>%
  mutate(
    logbasal.m2 = log(basal.m2),
    log.sub.dens = log(subplot_density))

summary(plot_D2h)

```










## Plot level basal area/m2 (LMEM) 



```{r}

#compare main effects to interactive model 

final.plot.basal.fit <- lmer(logbasal.m2 ~ rainfall + (1|landform/plots), data = plot_D2h, REML = T)

summary(final.plot.basal.fit)

```



### assumptions

```{r}
qqnorm(residuals(final.plot.basal.fit), pch = 1, frame = FALSE)
qqline(residuals(final.plot.basal.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.plot.basal.fit) ~ fitted(final.plot.basal.fit))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(final.plot.basal.fit)

# Perform the ACF analysis
 acf(residuals)
```

### fixed effect hypothesis testing 

```{r}
final.plot.basal.fit <- lmer(logbasal.m2 ~ rainfall +  (1|landform/plots), data = plot_D2h, REML = F)

final.plot.basal.null <- lmer(logbasal.m2 ~ (1|landform/plots), data = plot_D2h, REML = F)

anova(final.plot.basal.null,final.plot.basal.fit,test = "LRT")
```


***evidence to include rainfall***

### hypothesis testing for random effects





```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.basal.null <- lmer(logbasal.m2 ~ rainfall +  (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.plot.basal.fit <- lmer(logbasal.m2 ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.basal.fit) - 2 * logLik(final.plot.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logBasalSim <- unlist(simulate(final.plot.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logBasalSim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```



***no evidence to include landform***


```{r}
#test if we need  plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.basal.null <- aov(logbasal.m2 ~ rainfall, data = plot_D2h) #null w/o random effect
final.plot.basal.fit <- lmer(logbasal.m2 ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.basal.fit) - 2 * logLik(final.plot.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logBasalSim <- unlist(simulate(final.plot.basal.null)) # resampled data
  bNull <- aov(logBasalSim ~ rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logBasalSim ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```

***evidence to plots and a random effect*** 


## Final Plot level biomass Model

```{r}

final.plot.basal.fit <- lmer(logbasal.m2 ~  rainfall + (1|plots), data = plot_D2h, REML = F)

summary(final.plot.basal.fit)
```


```{r}
#CIs for stand basal area


confint(final.plot.basal.fit)

```



```{r}
#CIs and estimates for stand basal area low

exp(1.8895)     #mean

exp(1.6344626)  #low

exp(2.1412465)  #high 



```


```{r}
#CIs and estimates for stand basal area moderate

exp(1.8895 -0.5214)         #mean

exp(1.6344626 - 0.8883844)  #low

exp(2.1412465 - 0.1649531)  #high 


```



```{r}
#CIs and estimates for stand basal area moderate

exp(1.8895 +  0.2361)       #mean

exp(1.6344626 - 0.1692712)  #low

exp(2.1412465 + 0.6396652)  #high 


```




```{r}
pairs(emmeans(final.plot.basal.fit, ~  rainfall))
```

***sig diff between moderate other sites***



```{r}
stands_basal <-plot_D2h %>%
  ggplot(aes( rainfall, basal.m2, fill = rainfall))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab(bquote("basal area "(cm^2 ~ m^-2)))+
  xlab( "")+
  ggtitle("B")+
  theme_cowplot()+
  theme(legend.position = "none")

print(stands_basal)
```

## final height/m2 (LMEM)


```{r}

#compare main effects to interactive model 

final.plot.height.fit <- lmer(log(height.m2) ~ rainfall + (1|landform/plots), data = plot_D2h, REML = T)

summary(final.plot.height.fit)

```

### assumptions


```{r}
qqnorm(residuals(final.plot.height.fit), pch = 1, frame = FALSE)
qqline(residuals(final.plot.height.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.plot.height.fit) ~ fitted(final.plot.height.fit))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(final.plot.height.fit)

# Perform the ACF analysis
 acf(residuals)
```


### fixed effect hypothesis testing



```{r}
final.plot.height.fit <- lmer(log(height.m2) ~ rainfall +  (1|landform/plots), data = plot_D2h, REML = F)

final.plot.height.null <- lmer(log(height.m2) ~ (1|landform/plots), data = plot_D2h, REML = F)

anova(final.plot.height.null,final.plot.height.fit,test = "LRT")
```
***rainfall significant***






### hypothesis testing for random effects



```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.height.null <- lmer(log(height.m2) ~ rainfall +  (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.plot.height.fit <- lmer(log(height.m2) ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.height.fit) - 2 * logLik(final.plot.height.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logHeightSim <- unlist(simulate(final.plot.height.null)) # resampled data
  bNull <- lmer(logHeightSim ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logHeightSim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```
***landform not significant ***


```{r}
#test if we need plots 

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.height.null <- aov(log(height.m2) ~ rainfall, data = plot_D2h) #null w/o random effect
final.plot.height.fit <- lmer(log(height.m2) ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.height.fit) - 2 * logLik(final.plot.height.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logHeightSim <- unlist(simulate(final.plot.height.null)) # resampled data
  bNull <- aov(logHeightSim ~ rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logHeightSim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```


***plot is significant***

## Final stand height 

```{r}
final.plot.height.fit <- lmer(log(height.m2) ~  rainfall + (1|plots), data = plot_D2h, REML = T)
summary(final.plot.height.fit)

```


```{r}
#CIs for stand height 

confint(final.plot.height.fit)

```


```{r}
#CIs and estimates for stand height low 

exp(3.0543)     # mean 

exp(2.6275736)  # lower

exp(3.4820417)  # upper

```


```{r}
#CIs and estimates for stand height moderate 

exp(3.0543 - 0.8673)     # mean 

exp(2.6275736 - 1.4611559)  # lower

exp(3.4820417 - 0.2754517)  # upper

```


```{r}
#CIs and estimates for stand height high 

exp(3.0543 + 1.2447)     # mean 

exp(2.6275736 + 0.6088990)  # lower

exp(3.4820417 + 1.8830937)  # upper

```



```{r}
pairs(emmeans(final.plot.height.fit, ~ "rainfall"))
```




```{r}
stand_height <-plot_D2h %>%
  ggplot(aes( rainfall, height.m2, fill = rainfall))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab(bquote("height "(cm ~ m^-2)))+
  xlab( "")+
  ggtitle("C")+
  theme_cowplot()+
  theme(legend.position = "none")

print(stand_height)
```

## Stand density model (LMEM)


```{r}
final.density.fit <- lmer(log.sub.dens ~ rainfall + (1|plots), data = plot_D2h, REML = F)

summary(final.density.fit)

confint(final.density.fit)
```


### assumptions


```{r}
qqnorm(residuals(final.density.fit), pch = 1, frame = FALSE)
qqline(residuals(final.density.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.density.fit) ~ fitted(final.density.fit))
```


```{r}
# Extract the residuals from the model
dens.residuals <- residuals(final.density.fit)

# Perform the ACF analysis
 acf(dens.residuals)
 
```


### fixed effect hypothesis testing 


```{r}
final.density.fit <- lmer(log.sub.dens ~ rainfall +  (1|landform/plots), data = plot_D2h, REML = F)

final.density.null <- lmer(log.sub.dens ~ (1|landform/plots), data = plot_D2h, REML = F)

anova(final.density.fit,final.density.null,test = "LRT")
```

***rainfall is significant***

### hypothesis testing for random effects



```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.density.null <- lmer(log.sub.dens ~ rainfall +  (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.density.fit <- lmer(log.sub.dens ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.density.fit) - 2 * logLik(final.density.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logdensitySim <- unlist(simulate(final.density.null)) # resampled data
  bNull <- lmer(logdensitySim ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logdensitySim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```


***no evidence to include landforms as a randome effect***



```{r}
#test if we need plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.density.null <- aov(log.sub.dens ~ rainfall, data = plot_D2h) #null w/o random effect
final.density.fit <- lmer(log.sub.dens ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.density.fit) - 2 * logLik(final.density.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logdensitySim <- unlist(simulate(final.density.null)) # resampled data
  bNull <- aov(log.sub.dens ~ rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logdensitySim ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```





## Final stand density model

```{r}
final.density.fit <- lmer(log.sub.dens ~ rainfall + (1|plots), data = plot_D2h, REML = F)

summary(final.density.fit)

```




```{r}
## CIs and estimates for stand density 


confint(final.density.fit)
```




```{r}

# CIs for low rainfall stand density 


exp( -2.9131 )  # mean 

exp(-3.3674690) # lower 

exp(-2.4532340) # upper 

```



```{r}

# CIs for moderate  rainfall stand density 


exp( -2.9131 - 1.0380)      # mean 

exp(-3.3674690 - 1.6727049) # lower 

exp(-2.4532340 - 0.4103226) # upper 

```


```{r}

# CIs for high rainfall stand density 


exp( -2.9131 +  1.0194)      # mean 

exp(-3.3674690 + 0.3587745) # lower 

exp(-2.4532340 + 1.7050202) # upper 

```





```{r}
pairs(emmeans(final.density.fit, ~ rainfall))
```



```{r}
# Extract the residuals from the model
dens.residuals.fit <- residuals(final.density.fit)

# Perform the ACF analysis
 acf(dens.residuals.fit)
 
```



```{r}

final.tree.density <- plot_D2h%>%
  
  ggplot(aes(rainfall, subplot_density, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab(bquote("tree density "(trees ~ m^-2)))+
  xlab(" ")+
  ggtitle("A")+
  theme_cowplot()+
  theme(legend.position = "none")


print(final.tree.density)
```





## Competition model (LMEM) not sure if worth including ??

```{r}

final.add.competition.model <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|landform /plots), data = plot_D2h, REML = T)

summary(final.add.competition.model)
```

### assumptions

```{r}
vif(final.add.competition.model)
```

```{r}
# Extract the residuals from the model
ave.treebio.residuals.fit <- residuals(final.add.competition.model)

# Perform the ACF analysis
 acf(ave.treebio.residuals.fit)
 
```



```{r}
scatter.smooth(residuals(final.add.competition.model) ~ fitted(final.add.competition.model))
```



### fixed effect hypothesis testing

```{r}
# test significance of rainfall 

final.rainfall.competition.model <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F)

final.rainfall.competition.null <- lmer(log.sub.dens ~ log(ave.basal) + (1|landform/plots), data = plot_D2h, REML = F)

anova(final.rainfall.competition.null, final.rainfall.competition.model)

```


```{r}
# significance of ave.basal 


final.rainfall.competition.null <- lmer(log.sub.dens ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F)

anova(final.rainfall.competition.null, final.rainfall.competition.model)


```


### hypothesis testing for random effects 



final.rainfall.competition.model <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F)


```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.rainfall.compeition.null <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.final.competition.model <- lmer(log.sub.dens ~  log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.final.competition.model) - 2 * logLik(final.rainfall.compeition.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logDensitySim <- unlist(simulate(final.rainfall.compeition.null)) # resampled data
  bNull <- lmer(logDensitySim ~ log(ave.basal) + rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logDensitySim ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```

***landform non significant***


```{r}
nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.rainfall.compeition.null <- aov(log.sub.dens ~ log(ave.basal) + rainfall, data = plot_D2h) #null w/o random effect
final.final.competition.model <- lmer(log.sub.dens ~  log(ave.basal) + rainfall + (1|plots), data = plot_D2h, REML = F) #full model
lrObs <- 2 * logLik(final.final.competition.model) - 2 * logLik(final.rainfall.compeition.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logDensitySim <- unlist(simulate(final.rainfall.compeition.null)) # resampled data
  bNull <- aov(logDensitySim ~ log(ave.basal) + rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logDensitySim ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plot effect

```


***plots are not significant***






## Final competition model fit

```{r}
final.rainfall.compeition.model <- aov(log.sub.dens ~ log(ave.basal) + rainfall, data = plot_D2h)

anova(final.rainfall.compeition.model)
```


```{r}
TukeyHSD(final.rainfall.compeition.model, "rainfall")
```



```{r}
plot_D2h%>%
  ggplot( aes(ave.basal, subplot_density, colour = rainfall))+
  geom_point(aes(shape = landform))+
  geom_smooth(method = "lm", se = F)+
  ylab(bquote("tree density "(tree/m^2)))+
  xlab(bquote("average tree basal area " (cm^2/subplot)))+
  theme_cowplot()+
  theme(legend.position = "none")+
  scale_y_log10()+
  scale_x_log10()

```



```{r}
# Extract the residuals from the model
ave.treebio.residuals.fit <- residuals(final.rainfall.compeition.model)

# Perform the ACF analysis
 acf(ave.treebio.residuals.fit)
 
```







```{r}
vif(final.rainfall.compeition.model)
```



```{r}
plot_D2h%>%
  ggplot( aes(ave.basal, subplot_density, colour = rainfall))+
  geom_point(aes(shape = landform))+
  geom_smooth(method = "lm", se = F)+
  ylab(bquote("tree density "(tree/m^2)))+
  xlab(bquote("individual tree biomass " (kg/subplot)))+
  theme_cowplot()+
  theme(legend.position = "none")+
  scale_y_log10()+
  scale_x_log10()

```






## DIE OFF


## construct data set 

```{r}
library(readr)
noco_deadvalive <- read_csv("rainfall_data/noco_deadvalive.csv")

```

```{r}
noco_basal <- noco_deadvalive%>%
  gather("d_10", "diamiter", starts_with ("d_"))%>%
  mutate(
    status = as.factor(status),
    basal_area = (diamiter*0.5)^2*3.14159265359)%>%
  arrange(tree)%>%
  filter(!is.na(diamiter))
```


```{r}

noco_tree <- noco_basal%>%
group_by(tree)%>%
  summarise(height = mean(height),
            basal_area = sum(basal_area), 
            status = first(status))%>%
            mutate(
              log.basal = log(basal_area))

summary(noco_tree)

```



## rainfall data 
```{r}
rainfall_history <- read_csv("rainfall_data/rainfall_history.csv")


an.rainfall <- rainfall_history%>%
  mutate(
  rainfall = as.factor(rainfall),
  rainfall = factor(rainfall, levels = c("low", "moderate", "high")))

f.an.rainfall <- an.rainfall%>%
  filter(year > 1985)

summary(an.rainfall)
```







### Die off model 
```{r}
death.basal<- t.test(log.basal ~ status, mu = 0, data = noco_tree, var.equal = F, alt = "two.sided", paired = F)


print(death.basal)



```

```{r}
#CIs for estimated means die off 


t.test(log.basal ~ 1, conf.level = 0.95, data = subset(noco_tree, status == "a")) # alive trees 

t.test(log.basal ~ 1, conf.level = 0.95, data = subset(noco_tree, status == "d")) # dead trees

```



```{r}
# CIs for alive trees 

exp(5.258036) #mean BA for alive trees

exp(5.065706) #lower

exp(5.450365) #upper 

```




```{r}
# CIs for alive trees 

exp(3.602854) #mean BA for dead trees 

exp(3.392440) #lower

exp(3.813269) #upper

```




```{r}

dead_vs_alive <- noco_tree%>%
  ggplot(aes(status, basal_area, fill = status))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab(bquote("basal area "(cm^2)))+
  xlab("tree status")+
  ggtitle("A")+
  theme_cowplot()+
  theme(legend.position = "none")

 
print(dead_vs_alive)    
#ggsave("dead_vs_alive.png")
```
### plot chirps data

```{r}
rainfallTS<- f.an.rainfall%>%
  ggplot( aes(year, annual_precipitation, colour = rainfall))+
  geom_line()+
    ylab("annual precipitation (mm)")+
    xlab("year")+
    ggtitle("B")+
  theme_minimal()+
  theme(legend.position = "none")
  
  
print(rainfallTS) 
#ggsave("rainfallTS.png")

```


# FIGURES 

## Trait panel

```{r}
# traits/organs 

plot_grid(vessel.roundness, xylem_area, wood.density, d.massvsarea,  rel_widths = c(1,1))


ggsave("trait_comp.png", width = 12, height =10)

```




## structure panel 

```{r}

plot_grid(basal.vs.heigh_plots, canopyvsbasal, canopyvsheight, b.a_graph, heightvsrainfall, nrows = 2, ncol = 2, rel_widths = c(1,1))


ggsave("structral_comp.png", width = 10, height = 10)
```



## ecology panel

```{r}

plot_grid(final.tree.density, stands_basal, stand_height, nrows = 2, ncol = 2, rel_widths = c(1,1))


ggsave("stand_comp.png", width = 12, height = 10)

```

### Die off panel 


```{r}
plot_grid(dead_vs_alive, rainfallTS, nrows = 2, ncol = 1, rel_widths = c(1,1))

ggsave("dieoff_comp.png", width = 10, height = 6)
```


