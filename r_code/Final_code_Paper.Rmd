# STATs for Mulga trait shift paper 



# set up

```{r}

library(lme4) #mixed effect linear models

library(lmerTest)

library(emmeans)

library(tidyverse)

library(readr)

library(nlme)

library(ggpmisc)

library(cowplot)

library(car)

library(forcats)

library(mgcv)

library(glmmLasso)

library (glmmTMB)

library(sp)

library(gstat)

library(ape)

library(ggpmisc)

library(multcomp)

library(MASS)

library(betareg)

library(glmmTMB)

```


# TRAIT LEVEL METRICS


```{r}
#Plant vessel's Data

#build data set 

vessels <- read_csv("trait_data/vessel.csv")%>%
  mutate(rainfalllow = ifelse (grepl ("STURT", name), "low", "moderate"),
          rainfallhigh = ifelse (grepl ("GUNDA", name), "high", "moderate"),
          landform = ifelse (grepl ("SHED", name), "shed", "acc"),
          rainfall = ifelse(rainfalllow == "low", "low",
                          ifelse(rainfallhigh == "high", "high", "moderate")),
          rainfall = as.factor(rainfall),
         landform = as.factor(landform),
         length = as.numeric(length),
         width = as.numeric(width),
         rainfall = factor(rainfall, levels = c("low", "moderate", "high")))%>%
  
  #extract tree as a grouping factor from the name variable
  
  mutate(
    tree = substr(name, start = 1, stop = 13))%>%
  
  #get log transformations of various variables
  mutate(log.roundness = log(roundess),
         log.area = log(area))
 
  
  f.vessels <- vessels%>% 
    filter(, l_ratio > 0.20)%>%
    filter(, roundess > 0.15)%>%
    filter(, area < 3000)%>%
    filter(, area > 60)%>%
    filter(, width > 3)%>%
     
  #turn point values into area (pixel spacial resolution 1.17um across images on average with small variance (total range = 0.014um))
  mutate(area = 1.17*area,
         length = 1.17*length,
         width = 1.17*width,
         perimeter = 1.17*perimeter)


  summary(vessels)


```


```{r}

#leaf data 

total_leaves <- read_csv("trait_data/leaves/total_leaves.csv")%>%
  mutate( rainfall = factor(rainfall, levels = c("low", "moderate", "high")))


summary(total_leaves)

```
```{r}
trait_SLA <- total_leaves%>%
  mutate(
    tree_number = as.factor(tree_number),
    #mm^2/mg
    sla = leaf_area/leaf_mass,
    volume = leaf_area * leaf_thickness
    )%>%
  arrange(tree_number)%>%
  filter(!is.na(sla))%>%
  aggregate(sla~tree_number + landform + volume + leaf_area + leaf_thickness  + leaf_mass + wood_density + rainfall,mean)

summary(trait_SLA)
```

```{r}
# Wood density data

total_wood <- read_csv("~/Thesis/r_studio/trait_data/wood/total_wood.csv")%>%
  mutate( rainfall = factor(rainfall, levels = c("low", "moderate", "high")))


summary(total_wood)

```


```{r}

wood_data <- total_wood%>%
  mutate(
    basal_area = (wood_thickness*0.5)^2*3.14159265359,
    volume = basal_area * wood_length,
    wood.dens = wood_mass/volume)

summary(wood_data)

```



## Vessel roundness model (GLMM)


```{r}

lmem.roundness <- lmer(log.roundness ~ rainfall  + (1|landform/tree), data = f.vessels)

summary(lmem.roundness)

```



### Assumptions

```{r}

lmem.roundness <- lmer(log.roundness ~ rainfall + landform + (1|tree), data = f.vessels)

summary(lmem.roundness)

```



```{r}

scatter.smooth(residuals(lmem.roundness) ~ fitted(lmem.roundness))
```

```{r}
qqnorm(residuals(lmem.roundness), pch = 1, frame = FALSE)
qqline(residuals(lmem.roundness), col = "steelblue", lwd = 2)
```

***distributional assumptions not met find a new model***

```{r}
# Extract the residuals from the model
residuals <- residuals(lmem.roundness)

# Perform the ACF analysis
 acf(residuals)
```
### compare GLM with various distributional assumptions
```{r}
vessels%>%
  ggplot( aes(x = roundess))+
  geom_histogram()+
  ggtitle("vessel roundess distribution")
  
```
***fits beata distribution the best***



```{r}

gamma.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = Gamma())

beta.glmm.roundness <- glmmTMB(roundess ~ rainfall  + (1|landform/tree), data = f.vessels,family = beta_family())

anova(gamma.glmm.roundness, beta.glmm.roundness, test = "LRT")

```


```{r}
possion.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = poisson())

anova(beta.glmm.roundness, possion.glmm.roundness, test = "LRT")
```



```{r}

lmem.roundness <- lmer(log.roundness ~ rainfall + (1|landform/tree), data = f.vessels)

beta.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = beta_family())

# Compare the models using likelihood ratio test (LRT)
anova(lmem.roundness, beta.glmm.roundness, test = "LRT")

# Print the results
AIC(beta.glmm.roundness, lmem.roundness)
```


```{r}

scatter.smooth(residuals(beta.glmm.roundness) ~ fitted(beta.glmm.roundness))
```

```{r}
summary(beta.glmm.roundness)
```



***glmm with beta distribution best***



***rainfall not significant***




### dredging 

```{r}
beta.glmm.roundness <- glmmTMB(roundess ~ rainfall + (1|landform/tree), data = f.vessels,family = beta_family())

beta.glmm.roundness.null <- glmmTMB(roundess ~ (1|landform/tree), data = f.vessels,family = beta_family())

anova(beta.glmm.roundness, beta.glmm.roundness.null, test = "LRT")
```


***rainfall not significant***
```{r}
vessel.roundness <- ggplot( f.vessels, aes(rainfall, roundess, fill = rainfall))+
  geom_boxplot()+
  theme_cowplot()+
  scale_y_log10()+
  ylab ("xylem roundness")+
  xlab("rainfall site")+
  theme(legend.position = "none")

print(vessel.roundness)

```


## Vessel area model (LMEM)

```{r}

area.model <- lmer(log.area ~ rainfall +  (1|landform/tree), REML = T, data = f.vessels)


```


### assumptions


```{r}


qqnorm(residuals(area.model), pch = 1, frame = FALSE)
qqline(residuals(area.model), col = "steelblue", lwd = 2)
#plot(area.model, which = 2)


```

```{r}

scatter.smooth(residuals(area.model) ~ fitted(area.model))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(area.model)

# Perform the ACF analysis
 acf(residuals)
```

### dredging 


```{r}
area.model <- lmer(log.area ~ rainfall +  (1|landform/tree), REML = T, data = f.vessels)
area.model.null <- lmer(log.area ~  (1|landform/tree), REML = T, data = f.vessels)


anova(area.model, area.model.null, test = "LRT")
```

***rainfall not significant***




```{r}
#diamiter
ggplot(f.vessels, aes(log.area, colour = rainfall)) +
  geom_histogram()

xylem_area <- ggplot( f.vessels, aes(rainfall, area, fill = rainfall))+
  geom_boxplot()+
  theme_cowplot()+
  scale_y_log10()+
  ylab(bquote("xylem area " (Î¼m^2)))+
  xlab("rainfall site")+
  theme(legend.position = "none")

print(xylem_area)

```



## Wood denisty model 

```{r}

wood.dens.aov <- lmer(wood.dens ~ rainfall + (1|landform), data = wood_data)

summary(wood.dens.aov)

```



```{r}

qqnorm(residuals(wood.dens.aov), pch = 1, frame = FALSE)
qqline(residuals(wood.dens.aov), col = "steelblue", lwd = 2)

```



```{r}
scatter.smooth(residuals(wood.dens.aov) ~ fitted(wood.dens.aov))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(wood.dens.aov)

# Perform the ACF analysis
 acf(residuals)
```


### dredging 

```{r}

wood.dens.aov <- lmer(wood.dens ~ rainfall + (1|landform), data = wood_data, REML = T)
wood.dens.null <- lmer(wood.dens ~ (1|landform), data = wood_data, REML = T)

anova(wood.dens.aov, wood.dens.null, test = "LRT")

```

***rainfall not significant***

```{r}

wood.density <- wood_data%>%
  ggplot(aes(rainfall, wood.dens, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab(bquote("wood density " (g ~ cm^-3)))+
  theme_cowplot()+
  xlab(" ")+
  ggtitle("d")+
  theme(legend.position = "none")


print(wood.density)

```


```{r}
# Extract the residuals from the model
residuals <- residuals(wood.dens.aov)

# Perform the ACF analysis
 acf(residuals)
```







## SLA model 

```{r}
SLA.anova <- lmer(log(sla) ~ rainfall + (1|landform), data = trait_SLA, REML = F)
summary(SLA.anova)

```


```{r}

qqnorm(residuals(SLA.anova), pch = 1, frame = FALSE)
qqline(residuals(SLA.anova), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(SLA.anova) ~ fitted(SLA.anova))
```

```{r}
# Extract the residuals from the model
residuals <- residuals(SLA.anova)

# Perform the ACF analysis
 acf(residuals)
```


### dredging 

```{r}
SLA.anova <- lmer(log(sla) ~ rainfall + (1|landform), data = trait_SLA, REML = F)
SLA.anova.null <- lmer(log(sla) ~ (1|landform), data = trait_SLA, REML = F)


anova(SLA.anova,SLA.anova.null, test = "LRT")
```

### Final SLA model fit

```{r}
SLA.anova <- aov(log(sla) ~ rainfall, data = trait_SLA, REML = F)


TukeyHSD(SLA.anova)
```


## Leaf area 

```{r}

leaf_area.aov <- aov(log(leaf_area) ~  rainfall, data = trait_SLA)

summary(leaf_area.aov)

TukeyHSD(leaf_area.aov)

```




```{r}
qqnorm(residuals(leaf_area.aov), pch = 1, frame = FALSE)
qqline(residuals(leaf_area.aov), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(leaf_area.aov) ~ fitted(leaf_area.aov))
```


}
```{r}

# Extract the residuals from the model
residuals <- residuals(leaf_area.aov)

# Perform the ACF analysis
 acf(residuals)
```

****residual fit plot look weird*** 






# INDIVIUDAL TREE LEVEL METRICS

## build data sets

### import/build data set



```{r}
total_plots <- read_csv("plot_data/total_plots.csv")%>%
  mutate(
   landform = as.factor(landform),

    plots = as.factor(plots),
   
   subplot = as.factor(subplot),

    rainfall = factor(rainfall, levels = c("low", "moderate" , "high")))

summary(total_plots)
```



```{r}
total_wood <- read_csv("~/Thesis/r_studio/trait_data/wood/total_wood.csv")%>%
  mutate( rainfall = factor(rainfall, levels = c("low", "moderate", "high")))


summary(total_wood)

```


### calcuale basal area and summed biomass



```{r}

 #calculate basal area   
  basal_area <- total_plots %>%
  gather("d_10", "diamiter", starts_with ("d_"))%>%
  mutate(basal_area = (diamiter*0.5)^2*3.14159265359)%>%
  arrange(tree)%>%
  filter(!is.na(diamiter))
```

### biomass estimates for individual trees


```{r}
  
 # using the accacia allometric equation from feller 1980 we will calculate biomass for each tree based on a "stem by stem" analysis.
# see "Review of Allometric Relationships for Estimating Woody Biomass for New South Wales, the Australian Capital Territory, Victoria, Tasmania and South Australia" (page 36)
    D2H_model <- basal_area %>%
   group_by(tree, height, landform, plots, rainfall, subplot, sub_plot_area, subplot_density, plot_density)%>%
  summarise(basal_area = sum(basal_area),.groups = "drop")%>%
      mutate(diamiter = (sqrt(basal_area/3.14159265359))*2,
             dbh = (diamiter*0.798)-0.577,# tapering equation from Paul et al, "testing the generality of above ground ind_biomass allometry across plant functional types at the continent scale"
             stem_log_biomass = log(1.9+ 424.9 *(dbh/100)^2 * (height/100)), #ensure units of measurement are converted to cm
             stem_biomass = exp(stem_log_biomass),
             branch_log_biomass = log(208) + log((dbh/100)^2 * (height/100)),
             branch_biomass = exp(branch_log_biomass),
             leave_log_biomass = log(8) + log((dbh/100)^2 * (height/100)),
             leave_biomass = exp(leave_log_biomass))%>%
      mutate(
        biomass = stem_biomass + branch_biomass + leave_biomass,
        log_biomass = log(biomass))

```




### filtered 

```{r}
#filter out smaller trees due to allometeric differences in juveniles

f.D2H_model <- filter(D2H_model, diamiter > 2)


```



### allometric data with canopy volume

```{r}

allometry_total <- read_csv("allometry/allometry_total.csv")%>%
 mutate(
   landform = as.factor(landform),

    rainfall = factor(rainfall, levels = c( "low", "moderate", "high")))

summary(allometry_total)

```



### calculate basal area and canopy volume



```{r}

#calcualte basal area
allo_basal <- allometry_total %>%
  gather("d10", "diamiter", starts_with ("d10"))%>%
  mutate(basal_area = (diamiter*0.5)^2*3.14159265359)%>%
  arrange(tree)%>%
  filter(!is.na(diamiter))


```





```{r}

canopy_volume <- allo_basal%>%
  group_by(tree, canopy_1, canopy_2, `95_Canopy`, tree_height, landform, rainfall)%>%
  summarise(basal_area = sum(basal_area),.groups = "drop")%>%
  mutate(canopy_height = ((tree_height - `95_Canopy`)/2),  # divide by 2 to get the semi-axis
         canopy_length = canopy_1/2,
         canopy_bredth = canopy_2/2,
         canopy_volume = (3/4 * 3.141593 * canopy_height *canopy_bredth * canopy_length)/1000000,# volume of an ellipsoid. Divide by 1,000,000 to get m^3
         log.tree.H = log(tree_height),
         log.canopy.V = log(canopy_volume),
         log.basal_area = log(basal_area))%>%
  filter(!is.na(canopy_volume))%>%
  filter(!is.na(log.canopy.V))

  

```


```{r}

summary(allo_basal)

```




## Basal area (LMEM)


```{r}

final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|landform/plots/subplot), data = f.D2H_model, REML = T)

summary(final.basal.fit)

```
### assumptions

```{r}
qqnorm(residuals(final.basal.fit), pch = 1, frame = FALSE)
qqline(residuals(final.basal.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.basal.fit) ~ fitted(final.basal.fit))
```


```{r}
# Extract the residuals from the model
basal.residuals <- residuals(final.basal.fit)

# Perform the ACF analysis
 acf(basal.residuals)
```
### dredging 


final.height.basal.aov <- lmer(log(height) ~ log(basal_area) * rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F)
final.height.null <- lmer(log(height) ~ log(basal_area) + (1|landform/plots/subplot), data = f.D2H_model, REML = F)

anova(final.height.null,final.height.basal.aov,test = "LRT")


```{r}
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|landform/plots/subplot), data = f.D2H_model, REML = F)

final.basal.null <- lmer(log(basal_area) ~  (1| landform/plots/subplot), data = f.D2H_model, REML = F)

anova(final.basal.null, final.basal.fit, test = "LRT")
```


### random effect hypothesis testing 

```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.basal.null <- lmer(log(basal_area) ~  rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) #null model
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.basal.fit) - 2 * logLik(final.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logBasalSim <- unlist(simulate(final.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~  rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logBasalSim ~ rainfall + (1 | landform/plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```



```{r}
#test if we need plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.basal.null <- lmer(log(basal_area) ~  rainfall + (1|subplot) , data = f.D2H_model, REML = F) #null model
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.basal.fit) - 2 * logLik(final.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logBasalSim <- unlist(simulate(final.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~  rainfall + (1 |subplot), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logBasalSim ~ rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```
***plots significant***





```{r}
#test if we need landform given we have subplots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.basal.null <- lmer(log(basal_area) ~  rainfall + (1|plots) , data = f.D2H_model, REML = F) #null model
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.basal.fit) - 2 * logLik(final.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logBasalSim <- unlist(simulate(final.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~  rainfall + (1 | plots), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logBasalSim ~ rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```


***subplot significant***

##Final Basal area fit

pairs(emmeans(final.height.basal.lm, ~  rainfall))

```{r}
final.basal.fit <- lmer(log(basal_area) ~ rainfall + (1|plots/subplot) , data = f.D2H_model, REML = T) 


summary(final.basal.fit)

```




```{r}
pairs(emmeans(final.basal.fit, ~ "rainfall"))
```





```{r}

f.D2H_model %>%
  ggplot(aes(rainfall, basal_area, fill = rainfall))+
  geom_boxplot( notch = F)+
  scale_y_log10()+
  ylab(bquote("basal area "(cm^2)))+
  xlab(" ")+
  theme_cowplot()+
  theme(legend.position = "none",
        axis.title=element_text(size=12))


```






## Basal area to height (LMEM)



```{r}
#the interaction term (*) between log(basal_area) and rainfall allows the "height Vs basal areas" relationship to vary between levels of rainfall (or across sites). 

final.height.basal.lm <- lmer(log(height) ~ log(basal_area) * rainfall + (1|landform/plots/subplot), data = f.D2H_model, REML = T)

summary(final.height.basal.lm)

```

### assumptions
```{r}
qqnorm(residuals(final.height.basal.lm), pch = 1, frame = FALSE)
qqline(residuals(final.height.basal.lm), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.height.basal.lm) ~ fitted(final.height.basal.lm))
```





```{r}
vif(final.height.basal.lm)
```



```{r}
# Extract the residuals from the model
height.basal.residuals <- residuals(final.height.basal.lm)

# Perform the ACF analysis
 acf(height.basal.residuals)
```


### dredging

```{r}
# null vs fit

final.height.basal.aov <- lmer(log(height) ~ log(basal_area) * rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F)
final.height.null <- lmer(log(height) ~ log(basal_area) + (1|landform/plots/subplot), data = f.D2H_model, REML = F)

anova(final.height.null,final.height.basal.aov,test = "LRT")

```




### hypothesis testing for random effects

```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.height.basal.null <- lmer(log(height) ~ log(basal_area) * rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) #null model
final.height.basal.aov <- lmer(log(height) ~ log(basal_area) * rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.height.basal.aov) - 2 * logLik(final.height.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logHeightSim <- unlist(simulate(final.height.basal.null)) # resampled data
  bNull <- lmer(logHeightSim ~ log(basal_area) * rainfall + (1 | plots/subplot), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logHeightSim ~ log(basal_area) * rainfall + (1 | landform/plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```


```{r}
#test if we need subplots given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.height.basal.null <- lmer(log(height) ~ log(basal_area) * rainfall + (1|plots) , data = f.D2H_model, REML = F)
final.height.basal.aov <- lmer(log(height) ~ log(basal_area) * rainfall + (1|plots/subplot) , data = f.D2H_model, REML = F) # full model
lrObs <- 2 * logLik(final.height.basal.aov) - 2 * logLik(final.height.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  f.D2H_model$logHeightSim <- unlist(simulate(final.height.basal.null)) # resampled data
  bNull <- lmer(logHeightSim ~ log(basal_area) * rainfall + (1 | plots), data = f.D2H_model, REML = F) # null model
  bAlt <- lmer(logHeightSim ~ log(basal_area) * rainfall + (1 |plots/subplot), data = f.D2H_model, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```





## Final Basal area to height model 

```{r}
final.height.basal.lm <- lmer(log(height) ~ log(basal_area) * rainfall + (1|plots/subplot) , data = f.D2H_model, REML = T)

summary(final.height.basal.lm)
```


```{r}
pairs(emmeans(final.height.basal.lm, ~  rainfall))
```

```{r}
basal.vs.heigh_plots <- f.D2H_model%>%
  ggplot(aes(basal_area, height, colour = rainfall))+
  geom_point(aes(shape = landform))+
geom_smooth(method = "nls",
              formula = y ~ c*x^z,
             se = FALSE,
             method.args = list(start = list(c=125, z=0.383739)))+
  ylab("height (cm)")+
  xlab(bquote("basal area " (cm^2)))+
  xlim(c(NA, 1250))+
  ggtitle("a")+
  theme_cowplot()+
  theme(axis.title=element_text(size=12), legend.position = "none")
  

print(basal.vs.heigh_plots)

```


## Tree height (LMEM)

```{r}
final.tree.height.lm <- lmer(log(height) ~  rainfall + (1|landform/plots/subplot), data = f.D2H_model, REML = T)

summary(final.tree.height.lm)
```


### assumptions

```{r}

qqnorm(residuals(final.tree.height.lm), pch = 1, frame = FALSE)
qqline(residuals(final.tree.height.lm), col = "steelblue", lwd = 2)


```



```{r}
scatter.smooth(residuals(final.tree.height.lm) ~ fitted(final.tree.height.lm))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(final.tree.height.lm)

# Perform the ACF analysis
 acf(residuals)
```




### dredging

```{r}
final.tree.height.lm <- lmer(log(height) ~ rainfall + (1|landform/plots/subplot) , data = f.D2H_model, REML = F)

final.tree.height.null <- lmer(log(height) ~  (1|landform/plots/subplot) , data = f.D2H_model, REML = F)

anova(final.tree.height.null,final.tree.height.lm,test = "LRT")
```


***rainfall not significant***




## Canopy volume vs height (ANCOVA)



```{r}

final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = T)

summary(final.canopy.height.fit)

```


### assumptions
```{r}
qqnorm(residuals(final.canopy.height.fit ), pch = 1, frame = FALSE)
qqline(residuals(final.canopy.height.fit ), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.canopy.height.fit ) ~ fitted(final.canopy.height.fit ))
```


```{r}
# Extract the residuals from the model
cv.residuals <- residuals(final.canopy.height.fit )

# Perform the ACF analysis
 acf(cv.residuals)
```



```{r}
vif(final.canopy.height.fit)
```







### dredging 


```{r}
# significance of rainfall

final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = F)
final.canopy.height.null <- lmer(log.canopy.V ~ log.tree.H + (1|landform), data = canopy_volume, REML = T)

anova(final.canopy.height.null,final.canopy.height.fit,test = "LRT")

```

```{r}
# significance of height

final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = F)
final.canopy.height.null <- lmer(log.canopy.V ~ rainfall + (1|landform), data = canopy_volume, REML = T)

anova(final.canopy.height.null,final.canopy.height.fit,test = "LRT")

```

### structural sensitivity analysis


```{r}
# significance of interaction effect

final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H * rainfall + (1|landform), data = canopy_volume, REML = F)
final.canopy.height.null <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = T)

anova(final.canopy.height.null,final.canopy.height.fit,test = "LRT")

```

***do not include interactive effect***



### hypothesis testing for ranodm effect

```{r}
#test if we need landform as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.canopy.height.null <- aov(log.canopy.V ~ log.tree.H + rainfall, data = canopy_volume) #null w/o random effect
final.canopy.height.fit <- lmer(log.canopy.V ~ log.tree.H + rainfall + (1|landform), data = canopy_volume, REML = F) # full model
lrObs <- 2 * logLik(final.canopy.height.fit) - 2 * logLik(final.canopy.height.null) # observed test stat
for (iBoot in 1:nBoot)
{
  canopy_volume$logCanopySim <- unlist(simulate(final.canopy.height.null)) # resampled data
  bNull <- aov(logCanopySim ~ log.tree.H + rainfall, data = canopy_volume) # null model
  bAlt <- lmer(logCanopySim ~ log.tree.H + rainfall + (1 |landform), data = canopy_volume, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```
***no evidence to include landform***

## Final Canopy Volume vs Hight model


```{r}
final.canopy.height.aov <- aov(log.canopy.V ~ log.tree.H + rainfall, data = canopy_volume)

```



```{r}
vif(final.canopy.height.aov)
```



```{r}
# Extract the residuals from the model
cv.residuals <- residuals(final.canopy.height.aov)

# Perform the ACF analysis
 acf(cv.residuals)
```

```{r}
final.canopy.height.aov <- aov(log.canopy.V ~ log.tree.H * rainfall, data = canopy_volume)

Anova(final.canopy.height.aov, type="III") 

```

***non significant interaction = no change in slope***

```{r}
final.canopy.height.aov <- aov(log.canopy.V ~ log.tree.H + rainfall, data = canopy_volume)

Anova(final.canopy.height.aov, type="III") 

TukeyHSD(final.canopy.height.aov, "rainfall")
```

```{r}
canopyvsheight <- canopy_volume%>%
  ggplot( aes( tree_height, canopy_volume * 1000000, colour = rainfall))+
  geom_point(aes(shape = landform))+
  geom_smooth(method = "nls",
              formula = y ~b +x^m,
              se = F,
              method.args = list(start = list(m=3, b=0)))+
  ggtitle("b")+
  xlab("height (m)")+
  ylab(bquote("canopy volume  " (cm^3)))+
  theme_cowplot()
  theme(legend.position = "none",
        axis.title=element_text(size=12))


print(canopyvsheight)
```



## Canopy volume vs basal area (ANCOVA)



```{r}

final.canopy.basal.fit <- lmer(log.canopy.V ~ log.basal_area + rainfall + (1|landform), data = canopy_volume, REML = T)

summary(final.canopy.basal.fit)
```


### assumptions 

```{r}
qqnorm(residuals(final.canopy.basal.fit ), pch = 1, frame = FALSE)
qqline(residuals(final.canopy.basal.fit ), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.canopy.basal.fit ) ~ fitted(final.canopy.basal.fit ))
```


```{r}
# Extract the residuals from the model
cb.residuals <- residuals(final.canopy.basal.fit )

# Perform the ACF analysis
 acf(cb.residuals)
```

```{r}
vif(final.canopy.basal.fit)
```



### dredging


```{r}

final.canopy.basal.fit <- lmer(log.canopy.V ~ log.basal_area + rainfall + (1|landform), data = canopy_volume, REML = F)

final.canopy.basal.null <- lmer(log.canopy.V ~ log.basal_area + (1|landform), data = canopy_volume, REML = F)

anova(final.canopy.basal.null,final.canopy.basal.fit,test = "LRT")
```

```{r}
final.canopy.basal.null <- lmer(log.canopy.V ~ rainfall + (1|landform), data = canopy_volume, REML = F)

anova(final.canopy.basal.null,final.canopy.basal.fit,test = "LRT")
```
***rainfall not significant!!***






```{r}

basalvscanopy <- canopy_volume%>%
  ggplot( aes( basal_area, canopy_volume, colour = rainfall))+
  geom_point(aes(shape = landform))+
     geom_smooth(method = "nls",
              formula = y ~ b + x^m,
              se = FALSE,
              method.args = list(start = list(b= 0.4660558, m = 1.13)))+
  ylab(bquote("canopy volume " (m^3)))+
  xlab(bquote("basal area " (cm^2)))+
  ggtitle("c")+
  theme_cowplot()+
  theme(axis.title=element_text(size=12,face="bold"))+
  theme(legend.position = "none")
  


 print(basalvscanopy)
```






# PLOT LEVEL METRICS 

## build data set


```{r}

#create subplot level statistics    
  plot_D2h <- D2H_model%>%
  group_by( subplot )%>%
    summarise(
      sub_plot_area = mean(sub_plot_area),
      subplot_density = mean(subplot_density),
      ave.basal = mean(basal_area),
      diameter = mean(diamiter),
      ave.height = mean(height),
      tot.basal = sum(basal_area),
      tot.height = sum(height),
      stem_area = mean(3.1415/4*diamiter^2),
      basal.m2 = tot.basal/sub_plot_area,
      height.m2 = tot.height/sub_plot_area,
      plots = first(plots),
      plot_density = mean(plot_density),
      rainfall = first(rainfall),
      landform = first(landform))%>%
  ungroup()%>%
  mutate(
    logbasal.m2 = log(basal.m2),
    log.sub.dens = log(subplot_density))

summary(plot_D2h)

```










## Plot level basal area (LMEM) 



```{r}

#compare main effects to interactive model 

final.plot.basal.fit <- lmer(logbasal.m2 ~ rainfall + (1|landform/plots), data = plot_D2h, REML = T)

summary(final.plot.basal.fit)

```



### assumptions

```{r}
qqnorm(residuals(final.plot.basal.fit), pch = 1, frame = FALSE)
qqline(residuals(final.plot.basal.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.plot.basal.fit) ~ fitted(final.plot.basal.fit))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(final.plot.basal.fit)

# Perform the ACF analysis
 acf(residuals)
```

### dredging 

```{r}
final.plot.basal.fit <- lmer(logbasal.m2 ~ rainfall +  (1|landform/plots), data = plot_D2h, REML = F)

final.plot.basal.null <- lmer(logbasal.m2 ~ (1|landform/plots), data = plot_D2h, REML = F)

anova(final.plot.basal.null,final.plot.basal.fit,test = "LRT")
```


***evidence to include rainfall***

### hypothesis testing for random effects





```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.basal.null <- lmer(logbasal.m2 ~ rainfall +  (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.plot.basal.fit <- lmer(logbasal.m2 ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.basal.fit) - 2 * logLik(final.plot.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logBasalSim <- unlist(simulate(final.plot.basal.null)) # resampled data
  bNull <- lmer(logBasalSim ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logBasalSim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```



***no evidence to include landform***


```{r}
#test if we need  plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.plot.basal.null <- aov(logbasal.m2 ~ rainfall, data = plot_D2h) #null w/o random effect
final.plot.basal.fit <- lmer(logbasal.m2 ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.plot.basal.fit) - 2 * logLik(final.plot.basal.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logBasalSim <- unlist(simulate(final.plot.basal.null)) # resampled data
  bNull <- aov(logBasalSim ~ rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logBasalSim ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```

***evidence to plots and a random effect*** 


## Final Plot level biomass Model

```{r}
final.plot.basal.fit <- lmer(logbasal.m2 ~  rainfall + (1|plots), data = plot_D2h, REML = F)

summary(final.plot.basal.fit)
```

```{r}
pairs(emmeans(final.plot.basal.fit, ~  rainfall))
```

***sig diff between moderate and high, approaching significance (0.0566) for low and high***


***model summary suggests the high rainfall category is different to the low rainfall category, but the estimated marginal means indicates that it is not?***

```{r}
stands_boimass <-plot_D2h %>%
  ggplot(aes( rainfall, basal.m2, fill = rainfall))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab(bquote("basal area "(cm^2 ~ m^-2)))+
  xlab( "")+
  ggtitle("a")+
  theme_cowplot()+
  theme(legend.position = "none")

print(stands_boimass)
```

## height/m2 (LMEM)


```{r}

#compare main effects to interactive model 

final.plot.height.fit <- lmer(log(height.m2) ~ rainfall + (1|landform/plots), data = plot_D2h, REML = T)

summary(final.plot.height.fit)

```

### assumptions


```{r}
qqnorm(residuals(final.plot.height.fit), pch = 1, frame = FALSE)
qqline(residuals(final.plot.height.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.plot.height.fit) ~ fitted(final.plot.height.fit))
```


```{r}
# Extract the residuals from the model
residuals <- residuals(final.plot.height.fit)

# Perform the ACF analysis
 acf(residuals)
```


### dredging



```{r}
final.plot.height.fit <- lmer(log(height.m2) ~ rainfall +  (1|landform/plots), data = plot_D2h, REML = F)

final.plot.height.null <- lmer(log(height.m2) ~ (1|landform/plots), data = plot_D2h, REML = F)

anova(final.plot.height.null,final.plot.height.fit,test = "LRT")
```
***rainfall significant***


### hypothesis testing for randome effects


```{r}
stands_boimass <-plot_D2h %>%
  ggplot(aes( rainfall, height.m2, fill = rainfall))+
  geom_boxplot(notch = F)+
  scale_y_log10()+
  ylab(bquote("height "(m ~ m^-2)))+
  xlab( "")+
  ggtitle("b")+
  theme_cowplot()+
  theme(legend.position = "none")

print(stands_boimass)
```

## Stand density model (LMEM)


```{r}
final.density.fit <- lmer(log.sub.dens ~ rainfall + (1|landform/plots), data = plot_D2h, REML = F)

summary(final.density.fit)
```


### assumptions


```{r}
qqnorm(residuals(final.density.fit), pch = 1, frame = FALSE)
qqline(residuals(final.density.fit), col = "steelblue", lwd = 2)

```


```{r}
scatter.smooth(residuals(final.density.fit) ~ fitted(final.density.fit))
```


```{r}
# Extract the residuals from the model
dens.residuals <- residuals(final.density.fit)

# Perform the ACF analysis
 acf(dens.residuals)
 
```


### dreddging 


```{r}
final.density.fit <- lmer(log.sub.dens ~ rainfall +  (1|landform/plots), data = plot_D2h, REML = F)

final.density.null <- lmer(log.sub.dens ~ (1|landform/plots), data = plot_D2h, REML = F)

anova(final.density.fit,final.density.null,test = "LRT")
```

***rainfall is significant***

### hypothesis testing for random effects



```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.density.null <- lmer(log.sub.dens ~ rainfall +  (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.density.fit <- lmer(log.sub.dens ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.density.fit) - 2 * logLik(final.density.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logdensitySim <- unlist(simulate(final.density.null)) # resampled data
  bNull <- lmer(logdensitySim ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logdensitySim ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```


***no evidence to include landforms as a randome effect***



```{r}
#test if we need plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.density.null <- aov(log.sub.dens ~ rainfall, data = plot_D2h) #null w/o random effect
final.density.fit <- lmer(log.sub.dens ~ rainfall +  (1|plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.density.fit) - 2 * logLik(final.density.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logdensitySim <- unlist(simulate(final.density.null)) # resampled data
  bNull <- aov(log.sub.dens ~ rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logdensitySim ~  rainfall + (1|plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plots effect
```





## Final stand density model

```{r}
final.density.fit <- lmer(log.sub.dens ~ rainfall + (1|plots), data = plot_D2h, REML = F)


pairs(emmeans(final.density.fit, ~ rainfall))
```




```{r}
# Extract the residuals from the model
dens.residuals.fit <- residuals(final.density.fit)

# Perform the ACF analysis
 acf(dens.residuals.fit)
 
```



```{r}

final.tree.density <- plot_D2h%>%
  
  ggplot(aes(rainfall, subplot_density, fill = rainfall))+
  geom_boxplot()+
  scale_y_log10()+
  ylab(bquote("tree density "(trees ~ m^-2)))+
  xlab(" ")+
  ggtitle("b")+
  theme_cowplot()+
  theme(legend.position = "none")


print(final.tree.density)
```





## Competition model (LMEM) not sure if worth including ??

```{r}

final.add.competition.model <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|landform /plots), data = plot_D2h, REML = T)

summary(final.add.competition.model)
```

### assumptions

```{r}
vif(final.add.competition.model)
```

```{r}
# Extract the residuals from the model
ave.treebio.residuals.fit <- residuals(final.add.competition.model)

# Perform the ACF analysis
 acf(ave.treebio.residuals.fit)
 
```



```{r}
scatter.smooth(residuals(final.add.competition.model) ~ fitted(final.add.competition.model))
```



### dredging

```{r}
# test significance of rainfall 

final.rainfall.competition.model <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F)

final.rainfall.competition.null <- lmer(log.sub.dens ~ log(ave.basal) + (1|landform/plots), data = plot_D2h, REML = F)

anova(final.rainfall.competition.null, final.rainfall.competition.model)

```


```{r}
# significance of ave.basal 


final.rainfall.competition.null <- lmer(log.sub.dens ~  rainfall + (1|landform/plots), data = plot_D2h, REML = F)

anova(final.rainfall.competition.null, final.rainfall.competition.model)


```


### hypothesis testing for random effects 



final.rainfall.competition.model <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F)


```{r}
#test if we need landform given we have plots as a random effect

nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.rainfall.compeition.null <- lmer(log.sub.dens ~ log(ave.basal) + rainfall + (1|plots), data = plot_D2h, REML = F) #null w/o random effect
final.final.competition.model <- lmer(log.sub.dens ~  log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
lrObs <- 2 * logLik(final.final.competition.model) - 2 * logLik(final.rainfall.compeition.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logDensitySim <- unlist(simulate(final.rainfall.compeition.null)) # resampled data
  bNull <- lmer(logDensitySim ~ log(ave.basal) + rainfall +  (1|plots), data = plot_D2h, REML = F) # null model
  bAlt <- lmer(logDensitySim ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of landform effect
```

***landform non significant***


```{r}
nBoot <- 1000
lrStat <- rep(NA, nBoot)
final.rainfall.compeition.null <- aov(log.sub.dens ~ log(ave.basal) + rainfall, data = plot_D2h) #null w/o random effect
final.final.competition.model <- lmer(log.sub.dens ~  log(ave.basal) + rainfall + (1|plots), data = plot_D2h, REML = F) #full model
lrObs <- 2 * logLik(final.final.competition.model) - 2 * logLik(final.rainfall.compeition.null) # observed test stat
for (iBoot in 1:nBoot)
{
  plot_D2h$logDensitySim <- unlist(simulate(final.rainfall.compeition.null)) # resampled data
  bNull <- aov(logDensitySim ~ log(ave.basal) + rainfall, data = plot_D2h) # null model
  bAlt <- lmer(logDensitySim ~ log(ave.basal) + rainfall + (1|landform/plots), data = plot_D2h, REML = F) # full model
  lrStat[iBoot] <- 2 * logLik(bAlt) - 2 * logLik(bNull) # resampled test stat
}
mean(lrStat > lrObs) # P-value for test of plot effect

```


***plots are not significant***

## Final competition model fit

```{r}
final.rainfall.compeition.model <- aov(log.sub.dens ~ log(ave.basal) + rainfall, data = plot_D2h)

anova(final.rainfall.compeition.model)
```


```{r}
TukeyHSD(final.rainfall.compeition.model, "rainfall")
```



```{r}
plot_D2h%>%
  ggplot( aes(ave.basal, subplot_density, colour = rainfall))+
  geom_point(aes(shape = landform))+
  geom_smooth(method = "lm", se = F)+
  ylab(bquote("tree density "(tree/m^2)))+
  xlab(bquote("average tree basal area " (cm^2/subplot)))+
  theme_cowplot()+
  theme(legend.position = "none")+
  scale_y_log10()+
  scale_x_log10()

```



```{r}
# Extract the residuals from the model
ave.treebio.residuals.fit <- residuals(final.rainfall.compeition.model)

# Perform the ACF analysis
 acf(ave.treebio.residuals.fit)
 
```







```{r}
vif(final.rainfall.compeition.model)
```



```{r}
plot_D2h%>%
  ggplot( aes(ave.basal, subplot_density, colour = rainfall))+
  geom_point(aes(shape = landform))+
  geom_smooth(method = "lm", se = F)+
  ylab(bquote("tree density "(tree/m^2)))+
  xlab(bquote("individual tree biomass " (kg/subplot)))+
  theme_cowplot()+
  theme(legend.position = "none")+
  scale_y_log10()+
  scale_x_log10()

```














